diff --git a/node_modules/@metamask/eth-ledger-bridge-keyring/.DS_Store b/node_modules/@metamask/eth-ledger-bridge-keyring/.DS_Store
new file mode 100644
index 0000000..52caeee
Binary files /dev/null and b/node_modules/@metamask/eth-ledger-bridge-keyring/.DS_Store differ
diff --git a/node_modules/@metamask/eth-ledger-bridge-keyring/dist/ledger-bridge.d.ts b/node_modules/@metamask/eth-ledger-bridge-keyring/dist/ledger-bridge.d.ts
index 39f4cf2..e6efca7 100644
--- a/node_modules/@metamask/eth-ledger-bridge-keyring/dist/ledger-bridge.d.ts
+++ b/node_modules/@metamask/eth-ledger-bridge-keyring/dist/ledger-bridge.d.ts
@@ -1,5 +1,6 @@
 import type LedgerHwAppEth from '@ledgerhq/hw-app-eth';
 import type Transport from '@ledgerhq/hw-transport';
+import { EIP712Message } from '@ledgerhq/types-live';
 export type GetPublicKeyParams = {
     hdPath: string;
 };
@@ -16,8 +17,7 @@ export type LedgerSignMessageParams = {
 export type LedgerSignMessageResponse = Awaited<ReturnType<LedgerHwAppEth['signPersonalMessage']>>;
 export type LedgerSignTypedDataParams = {
     hdPath: string;
-    domainSeparatorHex: string;
-    hashStructMessageHex: string;
+    message: EIP712Message;
 };
 export type LedgerSignTypedDataResponse = Awaited<ReturnType<LedgerHwAppEth['signEIP712HashedMessage']>>;
 export type LedgerBridgeOptions = Record<string, unknown>;
diff --git a/node_modules/@metamask/eth-ledger-bridge-keyring/dist/ledger-bridge.js.map b/node_modules/@metamask/eth-ledger-bridge-keyring/dist/ledger-bridge.js.map
index 4dbc2f1..84f3c2c 100644
--- a/node_modules/@metamask/eth-ledger-bridge-keyring/dist/ledger-bridge.js.map
+++ b/node_modules/@metamask/eth-ledger-bridge-keyring/dist/ledger-bridge.js.map
@@ -1 +1 @@
-{"version":3,"file":"ledger-bridge.js","sourceRoot":"","sources":["../src/ledger-bridge.ts"],"names":[],"mappings":"","sourcesContent":["import type LedgerHwAppEth from '@ledgerhq/hw-app-eth';\nimport type Transport from '@ledgerhq/hw-transport';\n\nexport type GetPublicKeyParams = { hdPath: string };\nexport type GetPublicKeyResponse = Awaited<\n  ReturnType<LedgerHwAppEth['getAddress']>\n>;\n\nexport type LedgerSignTransactionParams = { hdPath: string; tx: string };\nexport type LedgerSignTransactionResponse = Awaited<\n  ReturnType<LedgerHwAppEth['signTransaction']>\n>;\n\nexport type LedgerSignMessageParams = { hdPath: string; message: string };\nexport type LedgerSignMessageResponse = Awaited<\n  ReturnType<LedgerHwAppEth['signPersonalMessage']>\n>;\n\nexport type LedgerSignTypedDataParams = {\n  hdPath: string;\n  domainSeparatorHex: string;\n  hashStructMessageHex: string;\n};\nexport type LedgerSignTypedDataResponse = Awaited<\n  ReturnType<LedgerHwAppEth['signEIP712HashedMessage']>\n>;\n\nexport type LedgerBridgeOptions = Record<string, unknown>;\n\nexport type LedgerBridge<T extends LedgerBridgeOptions> = {\n  isDeviceConnected: boolean;\n\n  init(): Promise<void>;\n\n  destroy(): Promise<void>;\n\n  /**\n   * Method to get the current configuration of the ledger bridge keyring.\n   */\n  getOptions(): Promise<T>;\n\n  /**\n   * Method to set the current configuration of the ledger bridge keyring.\n   *\n   * @param opts - An object contains configuration of the bridge.\n   */\n  setOptions(opts: T): Promise<void>;\n\n  attemptMakeApp(): Promise<boolean>;\n\n  updateTransportMethod(transportType: string | Transport): Promise<boolean>;\n\n  getPublicKey(params: GetPublicKeyParams): Promise<GetPublicKeyResponse>;\n\n  deviceSignTransaction(\n    params: LedgerSignTransactionParams,\n  ): Promise<LedgerSignTransactionResponse>;\n\n  deviceSignMessage(\n    params: LedgerSignMessageParams,\n  ): Promise<LedgerSignMessageResponse>;\n\n  deviceSignTypedData(\n    params: LedgerSignTypedDataParams,\n  ): Promise<LedgerSignTypedDataResponse>;\n};\n"]}
\ No newline at end of file
+{"version":3,"file":"ledger-bridge.js","sourceRoot":"","sources":["../src/ledger-bridge.ts"],"names":[],"mappings":"","sourcesContent":["import type LedgerHwAppEth from '@ledgerhq/hw-app-eth';\nimport type Transport from '@ledgerhq/hw-transport';\nimport { EIP712Message } from '@ledgerhq/types-live';\n\nexport type GetPublicKeyParams = { hdPath: string };\nexport type GetPublicKeyResponse = Awaited<\n  ReturnType<LedgerHwAppEth['getAddress']>\n>;\n\nexport type LedgerSignTransactionParams = { hdPath: string; tx: string };\nexport type LedgerSignTransactionResponse = Awaited<\n  ReturnType<LedgerHwAppEth['signTransaction']>\n>;\n\nexport type LedgerSignMessageParams = { hdPath: string; message: string };\nexport type LedgerSignMessageResponse = Awaited<\n  ReturnType<LedgerHwAppEth['signPersonalMessage']>\n>;\n\nexport type LedgerSignTypedDataParams = {\n  hdPath: string;\n  message: EIP712Message;\n};\nexport type LedgerSignTypedDataResponse = Awaited<\n  ReturnType<LedgerHwAppEth['signEIP712HashedMessage']>\n>;\n\nexport type LedgerBridgeOptions = Record<string, unknown>;\n\nexport type LedgerBridge<T extends LedgerBridgeOptions> = {\n  isDeviceConnected: boolean;\n\n  init(): Promise<void>;\n\n  destroy(): Promise<void>;\n\n  /**\n   * Method to get the current configuration of the ledger bridge keyring.\n   */\n  getOptions(): Promise<T>;\n\n  /**\n   * Method to set the current configuration of the ledger bridge keyring.\n   *\n   * @param opts - An object contains configuration of the bridge.\n   */\n  setOptions(opts: T): Promise<void>;\n\n  attemptMakeApp(): Promise<boolean>;\n\n  updateTransportMethod(transportType: string | Transport): Promise<boolean>;\n\n  getPublicKey(params: GetPublicKeyParams): Promise<GetPublicKeyResponse>;\n\n  deviceSignTransaction(\n    params: LedgerSignTransactionParams,\n  ): Promise<LedgerSignTransactionResponse>;\n\n  deviceSignMessage(\n    params: LedgerSignMessageParams,\n  ): Promise<LedgerSignMessageResponse>;\n\n  deviceSignTypedData(\n    params: LedgerSignTypedDataParams,\n  ): Promise<LedgerSignTypedDataResponse>;\n};\n"]}
\ No newline at end of file
diff --git a/node_modules/@metamask/eth-ledger-bridge-keyring/dist/ledger-keyring.js b/node_modules/@metamask/eth-ledger-bridge-keyring/dist/ledger-keyring.js
index 9607c20..efe9c78 100644
--- a/node_modules/@metamask/eth-ledger-bridge-keyring/dist/ledger-keyring.js
+++ b/node_modules/@metamask/eth-ledger-bridge-keyring/dist/ledger-keyring.js
@@ -339,18 +339,27 @@ class LedgerKeyring extends events_1.EventEmitter {
             throw new Error('Ledger: Only version 4 of typed data signing is supported');
         }
         const { domain, types, primaryType, message } = eth_sig_util_1.TypedDataUtils.sanitizeData(data);
-        const domainSeparatorHex = eth_sig_util_1.TypedDataUtils.hashStruct('EIP712Domain', domain, types, eth_sig_util_1.SignTypedDataVersion.V4).toString('hex');
-        const hashStructMessageHex = eth_sig_util_1.TypedDataUtils.hashStruct(primaryType.toString(), message, types, eth_sig_util_1.SignTypedDataVersion.V4).toString('hex');
         const hdPath = await this.unlockAccountByAddress(withAccount);
         if (!hdPath) {
             throw new Error('Ledger: Unknown error while signing message');
         }
+        const pt = primaryType.toString();
         let payload;
         try {
             payload = await this.bridge.deviceSignTypedData({
                 hdPath,
-                domainSeparatorHex,
-                hashStructMessageHex,
+                message: {
+                    domain: {
+                        name: domain.name,
+                        chainId: domain.chainId,
+                        version: domain.version,
+                        verifyingContract: domain.verifyingContract,
+                        salt: domain.salt ? new TextDecoder().decode(domain.salt) : undefined,
+                    },
+                    types,
+                    primaryType: pt,
+                    message,
+                },
             });
         }
         catch (error) {
diff --git a/node_modules/@metamask/eth-ledger-bridge-keyring/dist/ledger-keyring.js.map b/node_modules/@metamask/eth-ledger-bridge-keyring/dist/ledger-keyring.js.map
index 5021e52..d0c63ab 100644
--- a/node_modules/@metamask/eth-ledger-bridge-keyring/dist/ledger-keyring.js.map
+++ b/node_modules/@metamask/eth-ledger-bridge-keyring/dist/ledger-keyring.js.map
@@ -1 +1 @@
-{"version":3,"file":"ledger-keyring.js","sourceRoot":"","sources":["../src/ledger-keyring.ts"],"names":[],"mappings":"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","sourcesContent":["import { RLP } from '@ethereumjs/rlp';\nimport { TransactionFactory, TxData, TypedTransaction } from '@ethereumjs/tx';\nimport * as ethUtil from '@ethereumjs/util';\nimport type { MessageTypes, TypedMessage } from '@metamask/eth-sig-util';\nimport {\n  recoverPersonalSignature,\n  recoverTypedSignature,\n  SignTypedDataVersion,\n  TypedDataUtils,\n} from '@metamask/eth-sig-util';\nimport { Buffer } from 'buffer';\nimport type OldEthJsTransaction from 'ethereumjs-tx';\nimport { EventEmitter } from 'events';\nimport HDKey from 'hdkey';\n\nimport { LedgerBridge, LedgerBridgeOptions } from './ledger-bridge';\nimport { LedgerIframeBridgeOptions } from './ledger-iframe-bridge';\n\nconst pathBase = 'm';\nconst hdPathString = `${pathBase}/44'/60'/0'`;\nconst keyringType = 'Ledger Hardware';\n\n// This number causes one of our failing tests to run very slowly, as the for loop needs to iterate 1000 times.\nconst MAX_INDEX = 1000;\n\nenum NetworkApiUrls {\n  Ropsten = 'https://api-ropsten.etherscan.io',\n  Kovan = 'https://api-kovan.etherscan.io',\n  Rinkeby = 'https://api-rinkeby.etherscan.io',\n  Mainnet = `https://api.etherscan.io`,\n}\n\ntype SignTransactionPayload = Awaited<\n  ReturnType<LedgerBridge<LedgerIframeBridgeOptions>['deviceSignTransaction']>\n>;\n\nexport type AccountPageEntry = {\n  address: string;\n  balance: number | null;\n  index: number;\n};\n\nexport type AccountPage = AccountPageEntry[];\n\nexport type AccountDetails = {\n  index?: number;\n  bip44?: boolean;\n  hdPath?: string;\n};\n\nexport type LedgerBridgeKeyringOptions = {\n  hdPath: string;\n  accounts: readonly string[];\n  deviceId: string;\n  accountDetails: Readonly<Record<string, AccountDetails>>;\n  accountIndexes: Readonly<Record<string, number>>;\n  implementFullBIP44: boolean;\n};\n\n/**\n * Check if the given transaction is made with ethereumjs-tx or @ethereumjs/tx\n *\n * Transactions built with older versions of ethereumjs-tx have a\n * getChainId method that newer versions do not.\n * Older versions are mutable\n * while newer versions default to being immutable.\n * Expected shape and type\n * of data for v, r and s differ (Buffer (old) vs BN (new)).\n *\n * @param tx - Transaction to check, instance of either ethereumjs-tx or @ethereumjs/tx.\n * @returns Returns `true` if tx is an old-style ethereumjs-tx transaction.\n */\nfunction isOldStyleEthereumjsTx(\n  tx: TypedTransaction | OldEthJsTransaction,\n): tx is OldEthJsTransaction {\n  return 'getChainId' in tx && typeof tx.getChainId === 'function';\n}\n\nexport class LedgerKeyring extends EventEmitter {\n  static type: string = keyringType;\n\n  deviceId = '';\n\n  readonly type: string = keyringType;\n\n  page = 0;\n\n  perPage = 5;\n\n  unlockedAccount = 0;\n\n  accounts: readonly string[] = [];\n\n  accountDetails: Record<string, AccountDetails> = {};\n\n  hdk = new HDKey();\n\n  hdPath = hdPathString;\n\n  paths: Record<string, number> = {};\n\n  network: NetworkApiUrls = NetworkApiUrls.Mainnet;\n\n  implementFullBIP44 = false;\n\n  bridge: LedgerBridge<LedgerBridgeOptions>;\n\n  constructor({ bridge }: { bridge: LedgerBridge<LedgerBridgeOptions> }) {\n    super();\n\n    if (!bridge) {\n      throw new Error('Bridge is a required dependency for the keyring');\n    }\n\n    this.bridge = bridge;\n  }\n\n  async init(): Promise<void> {\n    return this.bridge.init();\n  }\n\n  async destroy(): Promise<void> {\n    return this.bridge.destroy();\n  }\n\n  async serialize(): Promise<\n    Partial<LedgerBridgeKeyringOptions> // Maybe we should have a proper \"state\" type here instead of using this \"options\" type.\n  > {\n    return {\n      hdPath: this.hdPath,\n      accounts: this.accounts,\n      deviceId: this.deviceId,\n      accountDetails: this.accountDetails,\n      implementFullBIP44: false,\n    };\n  }\n\n  async deserialize(\n    opts: Partial<LedgerBridgeKeyringOptions> = {}, // Same question here?\n  ): Promise<void> {\n    this.hdPath = opts.hdPath ?? hdPathString;\n    this.accounts = opts.accounts ?? [];\n    this.deviceId = opts.deviceId ?? '';\n    this.accountDetails = opts.accountDetails ?? {};\n\n    if (!opts.accountDetails) {\n      this.#migrateAccountDetails(opts);\n    }\n\n    this.implementFullBIP44 = opts.implementFullBIP44 ?? false;\n\n    const keys = new Set<string>(Object.keys(this.accountDetails));\n    // Remove accounts that don't have corresponding account details\n    this.accounts = this.accounts.filter((account) =>\n      keys.has(ethUtil.toChecksumAddress(account)),\n    );\n\n    return Promise.resolve();\n  }\n\n  public setDeviceId(deviceId: string): void {\n    this.deviceId = deviceId;\n  }\n\n  public getDeviceId(): string {\n    return this.deviceId;\n  }\n\n  #migrateAccountDetails(opts: Partial<LedgerBridgeKeyringOptions>): void {\n    if (this.#isLedgerLiveHdPath() && opts.accountIndexes) {\n      for (const [account, index] of Object.entries(opts.accountIndexes)) {\n        this.accountDetails[account] = {\n          bip44: true,\n          hdPath: this.#getPathForIndex(index),\n        };\n      }\n    }\n    const keys = new Set<string>(Object.keys(this.accountDetails));\n    // try to migrate non-LedgerLive accounts too\n    if (!this.#isLedgerLiveHdPath()) {\n      this.accounts.forEach((account) => {\n        const key = ethUtil.toChecksumAddress(account);\n\n        if (!keys.has(key)) {\n          this.accountDetails[key] = {\n            bip44: false,\n            hdPath: this.#pathFromAddress(account),\n          };\n        }\n      });\n    }\n  }\n\n  isUnlocked(): boolean {\n    return Boolean(this.hdk.publicKey);\n  }\n\n  isConnected(): boolean {\n    return this.bridge.isDeviceConnected;\n  }\n\n  setAccountToUnlock(index: number): void {\n    this.unlockedAccount = index;\n  }\n\n  setHdPath(hdPath: string): void {\n    // Reset HDKey if the path changes\n    if (this.hdPath !== hdPath) {\n      this.hdk = new HDKey();\n    }\n    this.hdPath = hdPath;\n  }\n\n  async unlock(hdPath?: string, updateHdk = true): Promise<string> {\n    if (this.isUnlocked() && !hdPath) {\n      return 'already unlocked';\n    }\n    const path = hdPath ? this.#toLedgerPath(hdPath) : this.hdPath;\n\n    let payload;\n    try {\n      payload = await this.bridge.getPublicKey({\n        hdPath: path,\n      });\n    } catch (error) {\n      throw error instanceof Error\n        ? error\n        : new Error('Ledger Ethereum app closed. Open it to unlock.');\n    }\n\n    if (updateHdk && payload.chainCode) {\n      this.hdk.publicKey = Buffer.from(payload.publicKey, 'hex');\n      this.hdk.chainCode = Buffer.from(payload.chainCode, 'hex');\n    }\n\n    return payload.address;\n  }\n\n  async addAccounts(amount = 1): Promise<string[]> {\n    return new Promise((resolve, reject) => {\n      this.unlock()\n        .then(async (_) => {\n          const from = this.unlockedAccount;\n          const to = from + amount;\n          const newAccounts: string[] = [];\n          for (let i = from; i < to; i++) {\n            const path = this.#getPathForIndex(i);\n            let address;\n            if (this.#isLedgerLiveHdPath()) {\n              address = await this.unlock(path);\n            } else {\n              address = this.#addressFromIndex(pathBase, i);\n            }\n\n            this.accountDetails[ethUtil.toChecksumAddress(address)] = {\n              // TODO: consider renaming this property, as the current name is misleading\n              // It's currently used to represent whether an account uses the Ledger Live path.\n              bip44: this.#isLedgerLiveHdPath(),\n              hdPath: path,\n            };\n\n            if (!this.accounts.includes(address)) {\n              this.accounts = [...this.accounts, address];\n              newAccounts.push(address);\n            }\n            this.page = 0;\n          }\n          resolve(newAccounts);\n        })\n        .catch(reject);\n    });\n  }\n\n  getName(): string {\n    return keyringType;\n  }\n\n  async getFirstPage(): Promise<AccountPage> {\n    this.page = 0;\n    return this.#getPage(1);\n  }\n\n  async getNextPage(): Promise<AccountPage> {\n    return this.#getPage(1);\n  }\n\n  async getPreviousPage(): Promise<AccountPage> {\n    return this.#getPage(-1);\n  }\n\n  async getAccounts(): Promise<string[]> {\n    return Promise.resolve(this.accounts.slice());\n  }\n\n  removeAccount(address: string): void {\n    const filteredAccounts = this.accounts.filter(\n      (a) => a.toLowerCase() !== address.toLowerCase(),\n    );\n\n    if (filteredAccounts.length === this.accounts.length) {\n      throw new Error(`Address ${address} not found in this keyring`);\n    }\n\n    this.accounts = filteredAccounts;\n    delete this.accountDetails[ethUtil.toChecksumAddress(address)];\n  }\n\n  async attemptMakeApp(): Promise<boolean> {\n    return this.bridge.attemptMakeApp();\n  }\n\n  async updateTransportMethod(transportType: string): Promise<boolean> {\n    return this.bridge.updateTransportMethod(transportType);\n  }\n\n  // tx is an instance of the ethereumjs-transaction class.\n  async signTransaction(\n    address: string,\n    tx: TypedTransaction | OldEthJsTransaction,\n  ): Promise<TypedTransaction | OldEthJsTransaction> {\n    let rawTxHex;\n    // transactions built with older versions of ethereumjs-tx have a\n    // getChainId method that newer versions do not. Older versions are mutable\n    // while newer versions default to being immutable. Expected shape and type\n    // of data for v, r and s differ (Buffer (old) vs BN (new))\n    if (isOldStyleEthereumjsTx(tx)) {\n      // In this version of ethereumjs-tx we must add the chainId in hex format\n      // to the initial v value. The chainId must be included in the serialized\n      // transaction which is only communicated to ethereumjs-tx in this\n      // value. In newer versions the chainId is communicated via the 'Common'\n      // object.\n      // @ts-expect-error tx.v should be a Buffer, but we are assigning a string\n      tx.v = ethUtil.bufferToHex(tx.getChainId());\n      // @ts-expect-error tx.r should be a Buffer, but we are assigning a string\n      tx.r = '0x00';\n      // @ts-expect-error tx.s should be a Buffer, but we are assigning a string\n      tx.s = '0x00';\n\n      rawTxHex = tx.serialize().toString('hex');\n\n      return this.#signTransaction(address, rawTxHex, (payload) => {\n        tx.v = Buffer.from(payload.v, 'hex');\n        tx.r = Buffer.from(payload.r, 'hex');\n        tx.s = Buffer.from(payload.s, 'hex');\n        return tx;\n      });\n    }\n\n    // The below `encode` call is only necessary for legacy transactions, as `getMessageToSign`\n    // calls `rlp.encode` internally for non-legacy transactions. As per the \"Transaction Execution\"\n    // section of the ethereum yellow paper, transactions need to be \"well-formed RLP, with no additional\n    // trailing bytes\".\n\n    // Note also that `getMessageToSign` will return valid RLP for all transaction types, whereas the\n    // `serialize` method will not for any transaction type except legacy. This is because `serialize` includes\n    // empty r, s and v values in the encoded rlp. This is why we use `getMessageToSign` here instead of `serialize`.\n    const messageToSign = tx.getMessageToSign(false);\n\n    rawTxHex = Buffer.isBuffer(messageToSign)\n      ? messageToSign.toString('hex')\n      : Buffer.from(RLP.encode(messageToSign)).toString('hex');\n\n    return this.#signTransaction(address, rawTxHex, (payload) => {\n      // Because tx will be immutable, first get a plain javascript object that\n      // represents the transaction. Using txData here as it aligns with the\n      // nomenclature of ethereumjs/tx.\n      const txData: TxData = tx.toJSON();\n      // The fromTxData utility expects a type to support transactions with a type other than 0\n      txData.type = tx.type;\n      // The fromTxData utility expects v,r and s to be hex prefixed\n      txData.v = ethUtil.addHexPrefix(payload.v);\n      txData.r = ethUtil.addHexPrefix(payload.r);\n      txData.s = ethUtil.addHexPrefix(payload.s);\n      // Adopt the 'common' option from the original transaction and set the\n      // returned object to be frozen if the original is frozen.\n      return TransactionFactory.fromTxData(txData, {\n        common: tx.common,\n        freeze: Object.isFrozen(tx),\n      });\n    });\n  }\n\n  async #signTransaction(\n    address: string,\n    rawTxHex: string,\n    handleSigning: (\n      payload: SignTransactionPayload,\n    ) => TypedTransaction | OldEthJsTransaction,\n  ): Promise<TypedTransaction | OldEthJsTransaction> {\n    const hdPath = await this.unlockAccountByAddress(address);\n\n    if (!hdPath) {\n      throw new Error('Ledger: Unknown error while signing transaction');\n    }\n\n    let payload;\n    try {\n      payload = await this.bridge.deviceSignTransaction({\n        tx: rawTxHex,\n        hdPath,\n      });\n    } catch (error) {\n      throw error instanceof Error\n        ? error\n        : new Error('Ledger: Unknown error while signing transaction');\n    }\n\n    const newOrMutatedTx = handleSigning(payload);\n    const valid = newOrMutatedTx.verifySignature();\n    if (valid) {\n      return newOrMutatedTx;\n    }\n    throw new Error('Ledger: The transaction signature is not valid');\n  }\n\n  async signMessage(withAccount: string, data: string): Promise<string> {\n    return this.signPersonalMessage(withAccount, data);\n  }\n\n  // For personal_sign, we need to prefix the message:\n  async signPersonalMessage(\n    withAccount: string,\n    message: string,\n  ): Promise<string> {\n    const hdPath = await this.unlockAccountByAddress(withAccount);\n\n    if (!hdPath) {\n      throw new Error('Ledger: Unknown error while signing message');\n    }\n\n    let payload;\n    try {\n      payload = await this.bridge.deviceSignMessage({\n        hdPath,\n        message: ethUtil.stripHexPrefix(message),\n      });\n    } catch (error) {\n      throw error instanceof Error\n        ? error\n        : new Error('Ledger: Unknown error while signing message');\n    }\n\n    let modifiedV = parseInt(String(payload.v), 10).toString(16);\n    if (modifiedV.length < 2) {\n      modifiedV = `0${modifiedV}`;\n    }\n\n    const signature = `0x${payload.r}${payload.s}${modifiedV}`;\n    const addressSignedWith = recoverPersonalSignature({\n      data: message,\n      signature,\n    });\n    if (\n      ethUtil.toChecksumAddress(addressSignedWith) !==\n      ethUtil.toChecksumAddress(withAccount)\n    ) {\n      throw new Error('Ledger: The signature doesnt match the right address');\n    }\n    return signature;\n  }\n\n  async unlockAccountByAddress(address: string): Promise<string | undefined> {\n    const checksummedAddress = ethUtil.toChecksumAddress(address);\n    const accountDetails = this.accountDetails[checksummedAddress];\n    if (!accountDetails) {\n      throw new Error(\n        `Ledger: Account for address '${checksummedAddress}' not found`,\n      );\n    }\n    const { hdPath } = accountDetails;\n    const unlockedAddress = await this.unlock(hdPath, false);\n\n    // unlock resolves to the address for the given hdPath as reported by the ledger device\n    // if that address is not the requested address, then this account belongs to a different device or seed\n    if (unlockedAddress.toLowerCase() !== address.toLowerCase()) {\n      throw new Error(\n        `Ledger: Account ${address} does not belong to the connected device`,\n      );\n    }\n    return hdPath;\n  }\n\n  async signTypedData<T extends MessageTypes>(\n    withAccount: string,\n    data: TypedMessage<T>,\n    options: { version?: string } = {},\n  ): Promise<string> {\n    const isV4 = options.version === 'V4';\n    if (!isV4) {\n      throw new Error(\n        'Ledger: Only version 4 of typed data signing is supported',\n      );\n    }\n\n    const { domain, types, primaryType, message } =\n      TypedDataUtils.sanitizeData(data);\n    const domainSeparatorHex = TypedDataUtils.hashStruct(\n      'EIP712Domain',\n      domain,\n      types,\n      SignTypedDataVersion.V4,\n    ).toString('hex');\n    const hashStructMessageHex = TypedDataUtils.hashStruct(\n      primaryType.toString(),\n      message,\n      types,\n      SignTypedDataVersion.V4,\n    ).toString('hex');\n\n    const hdPath = await this.unlockAccountByAddress(withAccount);\n\n    if (!hdPath) {\n      throw new Error('Ledger: Unknown error while signing message');\n    }\n\n    let payload;\n    try {\n      payload = await this.bridge.deviceSignTypedData({\n        hdPath,\n        domainSeparatorHex,\n        hashStructMessageHex,\n      });\n    } catch (error) {\n      throw error instanceof Error\n        ? error\n        : new Error('Ledger: Unknown error while signing message');\n    }\n\n    let recoveryId = parseInt(String(payload.v), 10).toString(16);\n    if (recoveryId.length < 2) {\n      recoveryId = `0${recoveryId}`;\n    }\n    const signature = `0x${payload.r}${payload.s}${recoveryId}`;\n    const addressSignedWith = recoverTypedSignature({\n      data,\n      signature,\n      version: SignTypedDataVersion.V4,\n    });\n\n    if (\n      ethUtil.toChecksumAddress(addressSignedWith) !==\n      ethUtil.toChecksumAddress(withAccount)\n    ) {\n      throw new Error('Ledger: The signature doesnt match the right address');\n    }\n    return signature;\n  }\n\n  exportAccount(): void {\n    throw new Error('Not supported on this device');\n  }\n\n  forgetDevice(): void {\n    this.deviceId = '';\n    this.accounts = [];\n    this.page = 0;\n    this.unlockedAccount = 0;\n    this.paths = {};\n    this.accountDetails = {};\n    this.hdk = new HDKey();\n  }\n\n  /* PRIVATE METHODS */\n  async #getPage(increment: number): Promise<AccountPage> {\n    this.page += increment;\n\n    if (this.page <= 0) {\n      this.page = 1;\n    }\n    const from = (this.page - 1) * this.perPage;\n    const to = from + this.perPage;\n\n    await this.unlock();\n    let accounts;\n    if (this.#isLedgerLiveHdPath()) {\n      accounts = await this.#getAccountsBIP44(from, to);\n    } else {\n      accounts = this.#getAccountsLegacy(from, to);\n    }\n    return accounts;\n  }\n\n  async #getAccountsBIP44(from: number, to: number): Promise<AccountPage> {\n    const accounts: AccountPage = [];\n\n    for (let i = from; i < to; i++) {\n      const path = this.#getPathForIndex(i);\n      const address = await this.unlock(path);\n      const valid = this.implementFullBIP44\n        ? await this.#hasPreviousTransactions(address)\n        : true;\n      accounts.push({\n        address,\n        balance: null,\n        index: i,\n      });\n\n      // PER BIP44\n      // \"Software should prevent a creation of an account if\n      // a previous account does not have a transaction history\n      // (meaning none of its addresses have been used before).\"\n      if (!valid) {\n        break;\n      }\n    }\n    return accounts;\n  }\n\n  #getAccountsLegacy(from: number, to: number): AccountPage {\n    const accounts: AccountPage = [];\n\n    for (let i = from; i < to; i++) {\n      const address = this.#addressFromIndex(pathBase, i);\n      accounts.push({\n        address,\n        balance: null,\n        index: i,\n      });\n      this.paths[ethUtil.toChecksumAddress(address)] = i;\n    }\n    return accounts;\n  }\n\n  #addressFromIndex(basePath: string, i: number): string {\n    const dkey = this.hdk.derive(`${basePath}/${i}`);\n    const address = ethUtil\n      .publicToAddress(dkey.publicKey, true)\n      .toString('hex');\n    return ethUtil.toChecksumAddress(`0x${address}`);\n  }\n\n  #pathFromAddress(address: string): string {\n    const checksummedAddress = ethUtil.toChecksumAddress(address);\n    let index = this.paths[checksummedAddress];\n    if (typeof index === 'undefined') {\n      for (let i = 0; i < MAX_INDEX; i++) {\n        if (checksummedAddress === this.#addressFromIndex(pathBase, i)) {\n          index = i;\n          break;\n        }\n      }\n    }\n\n    if (typeof index === 'undefined') {\n      throw new Error('Unknown address');\n    }\n    return this.#getPathForIndex(index);\n  }\n\n  #getPathForIndex(index: number): string {\n    // Check if the path is BIP 44 (Ledger Live)\n    return this.#isLedgerLiveHdPath()\n      ? `m/44'/60'/${index}'/0/0`\n      : `${this.hdPath}/${index}`;\n  }\n\n  #isLedgerLiveHdPath(): boolean {\n    return this.hdPath === `m/44'/60'/0'/0/0`;\n  }\n\n  #toLedgerPath(path: string): string {\n    return path.toString().replace('m/', '');\n  }\n\n  async #hasPreviousTransactions(address: string): Promise<boolean> {\n    const apiUrl = this.#getApiUrl();\n    const response = await window.fetch(\n      `${apiUrl}/api?module=account&action=txlist&address=${address}&tag=latest&page=1&offset=1`,\n    );\n    const parsedResponse = await response.json();\n    return parsedResponse.status !== '0' && parsedResponse.result.length > 0;\n  }\n\n  #getApiUrl(): NetworkApiUrls {\n    return this.network;\n  }\n}\n"]}
\ No newline at end of file
+{"version":3,"file":"ledger-keyring.js","sourceRoot":"","sources":["../src/ledger-keyring.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,yCAAsC;AACtC,uCAA8E;AAC9E,0DAA4C;AAE5C,yDAKgC;AAChC,mCAAgC;AAEhC,mCAAsC;AACtC,kDAA0B;AAK1B,MAAM,QAAQ,GAAG,GAAG,CAAC;AACrB,MAAM,YAAY,GAAG,GAAG,QAAQ,aAAa,CAAC;AAC9C,MAAM,WAAW,GAAG,iBAAiB,CAAC;AAEtC,+GAA+G;AAC/G,MAAM,SAAS,GAAG,IAAI,CAAC;AAEvB,IAAK,cAKJ;AALD,WAAK,cAAc;IACjB,8DAA4C,CAAA;IAC5C,0DAAwC,CAAA;IACxC,8DAA4C,CAAA;IAC5C,sDAAoC,CAAA;AACtC,CAAC,EALI,cAAc,KAAd,cAAc,QAKlB;AA6BD;;;;;;;;;;;;GAYG;AACH,SAAS,sBAAsB,CAC7B,EAA0C;IAE1C,OAAO,YAAY,IAAI,EAAE,IAAI,OAAO,EAAE,CAAC,UAAU,KAAK,UAAU,CAAC;AACnE,CAAC;AAED,MAAa,aAAc,SAAQ,qBAAY;IA6B7C,YAAY,EAAE,MAAM,EAAiD;QACnE,KAAK,EAAE,CAAC;;QA3BV,aAAQ,GAAG,EAAE,CAAC;QAEL,SAAI,GAAW,WAAW,CAAC;QAEpC,SAAI,GAAG,CAAC,CAAC;QAET,YAAO,GAAG,CAAC,CAAC;QAEZ,oBAAe,GAAG,CAAC,CAAC;QAEpB,aAAQ,GAAsB,EAAE,CAAC;QAEjC,mBAAc,GAAmC,EAAE,CAAC;QAEpD,QAAG,GAAG,IAAI,eAAK,EAAE,CAAC;QAElB,WAAM,GAAG,YAAY,CAAC;QAEtB,UAAK,GAA2B,EAAE,CAAC;QAEnC,YAAO,GAAmB,cAAc,CAAC,OAAO,CAAC;QAEjD,uBAAkB,GAAG,KAAK,CAAC;QAOzB,IAAI,CAAC,MAAM,EAAE,CAAC;YACZ,MAAM,IAAI,KAAK,CAAC,iDAAiD,CAAC,CAAC;QACrE,CAAC;QAED,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC;IACvB,CAAC;IAED,KAAK,CAAC,IAAI;QACR,OAAO,IAAI,CAAC,MAAM,CAAC,IAAI,EAAE,CAAC;IAC5B,CAAC;IAED,KAAK,CAAC,OAAO;QACX,OAAO,IAAI,CAAC,MAAM,CAAC,OAAO,EAAE,CAAC;IAC/B,CAAC;IAED,KAAK,CAAC,SAAS;QAGb,OAAO;YACL,MAAM,EAAE,IAAI,CAAC,MAAM;YACnB,QAAQ,EAAE,IAAI,CAAC,QAAQ;YACvB,QAAQ,EAAE,IAAI,CAAC,QAAQ;YACvB,cAAc,EAAE,IAAI,CAAC,cAAc;YACnC,kBAAkB,EAAE,KAAK;SAC1B,CAAC;IACJ,CAAC;IAED,KAAK,CAAC,WAAW,CACf,OAA4C,EAAE;QAE9C,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC,MAAM,IAAI,YAAY,CAAC;QAC1C,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC,QAAQ,IAAI,EAAE,CAAC;QACpC,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC,QAAQ,IAAI,EAAE,CAAC;QACpC,IAAI,CAAC,cAAc,GAAG,IAAI,CAAC,cAAc,IAAI,EAAE,CAAC;QAEhD,IAAI,CAAC,IAAI,CAAC,cAAc,EAAE,CAAC;YACzB,uBAAA,IAAI,sEAAuB,MAA3B,IAAI,EAAwB,IAAI,CAAC,CAAC;QACpC,CAAC;QAED,IAAI,CAAC,kBAAkB,GAAG,IAAI,CAAC,kBAAkB,IAAI,KAAK,CAAC;QAE3D,MAAM,IAAI,GAAG,IAAI,GAAG,CAAS,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,cAAc,CAAC,CAAC,CAAC;QAC/D,gEAAgE;QAChE,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC,OAAO,EAAE,EAAE,CAC/C,IAAI,CAAC,GAAG,CAAC,OAAO,CAAC,iBAAiB,CAAC,OAAO,CAAC,CAAC,CAC7C,CAAC;QAEF,OAAO,OAAO,CAAC,OAAO,EAAE,CAAC;IAC3B,CAAC;IAEM,WAAW,CAAC,QAAgB;QACjC,IAAI,CAAC,QAAQ,GAAG,QAAQ,CAAC;IAC3B,CAAC;IAEM,WAAW;QAChB,OAAO,IAAI,CAAC,QAAQ,CAAC;IACvB,CAAC;IA2BD,UAAU;QACR,OAAO,OAAO,CAAC,IAAI,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC;IACrC,CAAC;IAED,WAAW;QACT,OAAO,IAAI,CAAC,MAAM,CAAC,iBAAiB,CAAC;IACvC,CAAC;IAED,kBAAkB,CAAC,KAAa;QAC9B,IAAI,CAAC,eAAe,GAAG,KAAK,CAAC;IAC/B,CAAC;IAED,SAAS,CAAC,MAAc;QACtB,kCAAkC;QAClC,IAAI,IAAI,CAAC,MAAM,KAAK,MAAM,EAAE,CAAC;YAC3B,IAAI,CAAC,GAAG,GAAG,IAAI,eAAK,EAAE,CAAC;QACzB,CAAC;QACD,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC;IACvB,CAAC;IAED,KAAK,CAAC,MAAM,CAAC,MAAe,EAAE,SAAS,GAAG,IAAI;QAC5C,IAAI,IAAI,CAAC,UAAU,EAAE,IAAI,CAAC,MAAM,EAAE,CAAC;YACjC,OAAO,kBAAkB,CAAC;QAC5B,CAAC;QACD,MAAM,IAAI,GAAG,MAAM,CAAC,CAAC,CAAC,uBAAA,IAAI,6DAAc,MAAlB,IAAI,EAAe,MAAM,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC;QAE/D,IAAI,OAAO,CAAC;QACZ,IAAI,CAAC;YACH,OAAO,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,YAAY,CAAC;gBACvC,MAAM,EAAE,IAAI;aACb,CAAC,CAAC;QACL,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,MAAM,KAAK,YAAY,KAAK;gBAC1B,CAAC,CAAC,KAAK;gBACP,CAAC,CAAC,IAAI,KAAK,CAAC,gDAAgD,CAAC,CAAC;QAClE,CAAC;QAED,IAAI,SAAS,IAAI,OAAO,CAAC,SAAS,EAAE,CAAC;YACnC,IAAI,CAAC,GAAG,CAAC,SAAS,GAAG,eAAM,CAAC,IAAI,CAAC,OAAO,CAAC,SAAS,EAAE,KAAK,CAAC,CAAC;YAC3D,IAAI,CAAC,GAAG,CAAC,SAAS,GAAG,eAAM,CAAC,IAAI,CAAC,OAAO,CAAC,SAAS,EAAE,KAAK,CAAC,CAAC;QAC7D,CAAC;QAED,OAAO,OAAO,CAAC,OAAO,CAAC;IACzB,CAAC;IAED,KAAK,CAAC,WAAW,CAAC,MAAM,GAAG,CAAC;QAC1B,OAAO,IAAI,OAAO,CAAC,CAAC,OAAO,EAAE,MAAM,EAAE,EAAE;YACrC,IAAI,CAAC,MAAM,EAAE;iBACV,IAAI,CAAC,KAAK,EAAE,CAAC,EAAE,EAAE;gBAChB,MAAM,IAAI,GAAG,IAAI,CAAC,eAAe,CAAC;gBAClC,MAAM,EAAE,GAAG,IAAI,GAAG,MAAM,CAAC;gBACzB,MAAM,WAAW,GAAa,EAAE,CAAC;gBACjC,KAAK,IAAI,CAAC,GAAG,IAAI,EAAE,CAAC,GAAG,EAAE,EAAE,CAAC,EAAE,EAAE,CAAC;oBAC/B,MAAM,IAAI,GAAG,uBAAA,IAAI,gEAAiB,MAArB,IAAI,EAAkB,CAAC,CAAC,CAAC;oBACtC,IAAI,OAAO,CAAC;oBACZ,IAAI,uBAAA,IAAI,mEAAoB,MAAxB,IAAI,CAAsB,EAAE,CAAC;wBAC/B,OAAO,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;oBACpC,CAAC;yBAAM,CAAC;wBACN,OAAO,GAAG,uBAAA,IAAI,iEAAkB,MAAtB,IAAI,EAAmB,QAAQ,EAAE,CAAC,CAAC,CAAC;oBAChD,CAAC;oBAED,IAAI,CAAC,cAAc,CAAC,OAAO,CAAC,iBAAiB,CAAC,OAAO,CAAC,CAAC,GAAG;wBACxD,2EAA2E;wBAC3E,iFAAiF;wBACjF,KAAK,EAAE,uBAAA,IAAI,mEAAoB,MAAxB,IAAI,CAAsB;wBACjC,MAAM,EAAE,IAAI;qBACb,CAAC;oBAEF,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,QAAQ,CAAC,OAAO,CAAC,EAAE,CAAC;wBACrC,IAAI,CAAC,QAAQ,GAAG,CAAC,GAAG,IAAI,CAAC,QAAQ,EAAE,OAAO,CAAC,CAAC;wBAC5C,WAAW,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;oBAC5B,CAAC;oBACD,IAAI,CAAC,IAAI,GAAG,CAAC,CAAC;gBAChB,CAAC;gBACD,OAAO,CAAC,WAAW,CAAC,CAAC;YACvB,CAAC,CAAC;iBACD,KAAK,CAAC,MAAM,CAAC,CAAC;QACnB,CAAC,CAAC,CAAC;IACL,CAAC;IAED,OAAO;QACL,OAAO,WAAW,CAAC;IACrB,CAAC;IAED,KAAK,CAAC,YAAY;QAChB,IAAI,CAAC,IAAI,GAAG,CAAC,CAAC;QACd,OAAO,uBAAA,IAAI,wDAAS,MAAb,IAAI,EAAU,CAAC,CAAC,CAAC;IAC1B,CAAC;IAED,KAAK,CAAC,WAAW;QACf,OAAO,uBAAA,IAAI,wDAAS,MAAb,IAAI,EAAU,CAAC,CAAC,CAAC;IAC1B,CAAC;IAED,KAAK,CAAC,eAAe;QACnB,OAAO,uBAAA,IAAI,wDAAS,MAAb,IAAI,EAAU,CAAC,CAAC,CAAC,CAAC;IAC3B,CAAC;IAED,KAAK,CAAC,WAAW;QACf,OAAO,OAAO,CAAC,OAAO,CAAC,IAAI,CAAC,QAAQ,CAAC,KAAK,EAAE,CAAC,CAAC;IAChD,CAAC;IAED,aAAa,CAAC,OAAe;QAC3B,MAAM,gBAAgB,GAAG,IAAI,CAAC,QAAQ,CAAC,MAAM,CAC3C,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,WAAW,EAAE,KAAK,OAAO,CAAC,WAAW,EAAE,CACjD,CAAC;QAEF,IAAI,gBAAgB,CAAC,MAAM,KAAK,IAAI,CAAC,QAAQ,CAAC,MAAM,EAAE,CAAC;YACrD,MAAM,IAAI,KAAK,CAAC,WAAW,OAAO,4BAA4B,CAAC,CAAC;QAClE,CAAC;QAED,IAAI,CAAC,QAAQ,GAAG,gBAAgB,CAAC;QACjC,OAAO,IAAI,CAAC,cAAc,CAAC,OAAO,CAAC,iBAAiB,CAAC,OAAO,CAAC,CAAC,CAAC;IACjE,CAAC;IAED,KAAK,CAAC,cAAc;QAClB,OAAO,IAAI,CAAC,MAAM,CAAC,cAAc,EAAE,CAAC;IACtC,CAAC;IAED,KAAK,CAAC,qBAAqB,CAAC,aAAqB;QAC/C,OAAO,IAAI,CAAC,MAAM,CAAC,qBAAqB,CAAC,aAAa,CAAC,CAAC;IAC1D,CAAC;IAED,yDAAyD;IACzD,KAAK,CAAC,eAAe,CACnB,OAAe,EACf,EAA0C;QAE1C,IAAI,QAAQ,CAAC;QACb,iEAAiE;QACjE,2EAA2E;QAC3E,2EAA2E;QAC3E,2DAA2D;QAC3D,IAAI,sBAAsB,CAAC,EAAE,CAAC,EAAE,CAAC;YAC/B,yEAAyE;YACzE,yEAAyE;YACzE,kEAAkE;YAClE,wEAAwE;YACxE,UAAU;YACV,0EAA0E;YAC1E,EAAE,CAAC,CAAC,GAAG,OAAO,CAAC,WAAW,CAAC,EAAE,CAAC,UAAU,EAAE,CAAC,CAAC;YAC5C,0EAA0E;YAC1E,EAAE,CAAC,CAAC,GAAG,MAAM,CAAC;YACd,0EAA0E;YAC1E,EAAE,CAAC,CAAC,GAAG,MAAM,CAAC;YAEd,QAAQ,GAAG,EAAE,CAAC,SAAS,EAAE,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC;YAE1C,OAAO,uBAAA,IAAI,gEAAiB,MAArB,IAAI,EAAkB,OAAO,EAAE,QAAQ,EAAE,CAAC,OAAO,EAAE,EAAE;gBAC1D,EAAE,CAAC,CAAC,GAAG,eAAM,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC,EAAE,KAAK,CAAC,CAAC;gBACrC,EAAE,CAAC,CAAC,GAAG,eAAM,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC,EAAE,KAAK,CAAC,CAAC;gBACrC,EAAE,CAAC,CAAC,GAAG,eAAM,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC,EAAE,KAAK,CAAC,CAAC;gBACrC,OAAO,EAAE,CAAC;YACZ,CAAC,CAAC,CAAC;QACL,CAAC;QAED,2FAA2F;QAC3F,gGAAgG;QAChG,qGAAqG;QACrG,mBAAmB;QAEnB,iGAAiG;QACjG,2GAA2G;QAC3G,iHAAiH;QACjH,MAAM,aAAa,GAAG,EAAE,CAAC,gBAAgB,CAAC,KAAK,CAAC,CAAC;QAEjD,QAAQ,GAAG,eAAM,CAAC,QAAQ,CAAC,aAAa,CAAC;YACvC,CAAC,CAAC,aAAa,CAAC,QAAQ,CAAC,KAAK,CAAC;YAC/B,CAAC,CAAC,eAAM,CAAC,IAAI,CAAC,SAAG,CAAC,MAAM,CAAC,aAAa,CAAC,CAAC,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC;QAE3D,OAAO,uBAAA,IAAI,gEAAiB,MAArB,IAAI,EAAkB,OAAO,EAAE,QAAQ,EAAE,CAAC,OAAO,EAAE,EAAE;YAC1D,yEAAyE;YACzE,sEAAsE;YACtE,iCAAiC;YACjC,MAAM,MAAM,GAAW,EAAE,CAAC,MAAM,EAAE,CAAC;YACnC,yFAAyF;YACzF,MAAM,CAAC,IAAI,GAAG,EAAE,CAAC,IAAI,CAAC;YACtB,8DAA8D;YAC9D,MAAM,CAAC,CAAC,GAAG,OAAO,CAAC,YAAY,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC;YAC3C,MAAM,CAAC,CAAC,GAAG,OAAO,CAAC,YAAY,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC;YAC3C,MAAM,CAAC,CAAC,GAAG,OAAO,CAAC,YAAY,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC;YAC3C,sEAAsE;YACtE,0DAA0D;YAC1D,OAAO,uBAAkB,CAAC,UAAU,CAAC,MAAM,EAAE;gBAC3C,MAAM,EAAE,EAAE,CAAC,MAAM;gBACjB,MAAM,EAAE,MAAM,CAAC,QAAQ,CAAC,EAAE,CAAC;aAC5B,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;IACL,CAAC;IAmCD,KAAK,CAAC,WAAW,CAAC,WAAmB,EAAE,IAAY;QACjD,OAAO,IAAI,CAAC,mBAAmB,CAAC,WAAW,EAAE,IAAI,CAAC,CAAC;IACrD,CAAC;IAED,oDAAoD;IACpD,KAAK,CAAC,mBAAmB,CACvB,WAAmB,EACnB,OAAe;QAEf,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,sBAAsB,CAAC,WAAW,CAAC,CAAC;QAE9D,IAAI,CAAC,MAAM,EAAE,CAAC;YACZ,MAAM,IAAI,KAAK,CAAC,6CAA6C,CAAC,CAAC;QACjE,CAAC;QAED,IAAI,OAAO,CAAC;QACZ,IAAI,CAAC;YACH,OAAO,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,iBAAiB,CAAC;gBAC5C,MAAM;gBACN,OAAO,EAAE,OAAO,CAAC,cAAc,CAAC,OAAO,CAAC;aACzC,CAAC,CAAC;QACL,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,MAAM,KAAK,YAAY,KAAK;gBAC1B,CAAC,CAAC,KAAK;gBACP,CAAC,CAAC,IAAI,KAAK,CAAC,6CAA6C,CAAC,CAAC;QAC/D,CAAC;QAED,IAAI,SAAS,GAAG,QAAQ,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,QAAQ,CAAC,EAAE,CAAC,CAAC;QAC7D,IAAI,SAAS,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;YACzB,SAAS,GAAG,IAAI,SAAS,EAAE,CAAC;QAC9B,CAAC;QAED,MAAM,SAAS,GAAG,KAAK,OAAO,CAAC,CAAC,GAAG,OAAO,CAAC,CAAC,GAAG,SAAS,EAAE,CAAC;QAC3D,MAAM,iBAAiB,GAAG,IAAA,uCAAwB,EAAC;YACjD,IAAI,EAAE,OAAO;YACb,SAAS;SACV,CAAC,CAAC;QACH,IACE,OAAO,CAAC,iBAAiB,CAAC,iBAAiB,CAAC;YAC5C,OAAO,CAAC,iBAAiB,CAAC,WAAW,CAAC,EACtC,CAAC;YACD,MAAM,IAAI,KAAK,CAAC,sDAAsD,CAAC,CAAC;QAC1E,CAAC;QACD,OAAO,SAAS,CAAC;IACnB,CAAC;IAED,KAAK,CAAC,sBAAsB,CAAC,OAAe;QAC1C,MAAM,kBAAkB,GAAG,OAAO,CAAC,iBAAiB,CAAC,OAAO,CAAC,CAAC;QAC9D,MAAM,cAAc,GAAG,IAAI,CAAC,cAAc,CAAC,kBAAkB,CAAC,CAAC;QAC/D,IAAI,CAAC,cAAc,EAAE,CAAC;YACpB,MAAM,IAAI,KAAK,CACb,gCAAgC,kBAAkB,aAAa,CAChE,CAAC;QACJ,CAAC;QACD,MAAM,EAAE,MAAM,EAAE,GAAG,cAAc,CAAC;QAClC,MAAM,eAAe,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,MAAM,EAAE,KAAK,CAAC,CAAC;QAEzD,uFAAuF;QACvF,wGAAwG;QACxG,IAAI,eAAe,CAAC,WAAW,EAAE,KAAK,OAAO,CAAC,WAAW,EAAE,EAAE,CAAC;YAC5D,MAAM,IAAI,KAAK,CACb,mBAAmB,OAAO,0CAA0C,CACrE,CAAC;QACJ,CAAC;QACD,OAAO,MAAM,CAAC;IAChB,CAAC;IAED,KAAK,CAAC,aAAa,CACjB,WAAmB,EACnB,IAAqB,EACrB,UAAgC,EAAE;QAElC,MAAM,IAAI,GAAG,OAAO,CAAC,OAAO,KAAK,IAAI,CAAC;QACtC,IAAI,CAAC,IAAI,EAAE,CAAC;YACV,MAAM,IAAI,KAAK,CACb,2DAA2D,CAC5D,CAAC;QACJ,CAAC;QAED,MAAM,EAAE,MAAM,EAAE,KAAK,EAAE,WAAW,EAAE,OAAO,EAAE,GAC3C,6BAAc,CAAC,YAAY,CAAC,IAAI,CAAC,CAAC;QAEpC,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,sBAAsB,CAAC,WAAW,CAAC,CAAC;QAE9D,IAAI,CAAC,MAAM,EAAE,CAAC;YACZ,MAAM,IAAI,KAAK,CAAC,6CAA6C,CAAC,CAAC;QACjE,CAAC;QAED,MAAM,EAAE,GAAG,WAAW,CAAC,QAAQ,EAAE,CAAC;QAElC,IAAI,OAAO,CAAC;QACZ,IAAI,CAAC;YACH,OAAO,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,mBAAmB,CAAC;gBAC9C,MAAM;gBACN,OAAO,EAAE;oBACP,MAAM,EAAE;wBACN,IAAI,EAAE,MAAM,CAAC,IAAI;wBACjB,OAAO,EAAE,MAAM,CAAC,OAAO;wBACvB,OAAO,EAAE,MAAM,CAAC,OAAO;wBACvB,iBAAiB,EAAE,MAAM,CAAC,iBAAiB;wBAC3C,IAAI,EAAE,MAAM,CAAC,IAAI,CAAA,CAAC,CAAC,IAAI,WAAW,EAAE,CAAC,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,CAAA,CAAC,CAAC,SAAS;qBACpE;oBACD,KAAK;oBACL,WAAW,EAAE,EAAE;oBACf,OAAO;iBACR;aACF,CAAC,CAAC;QACL,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,MAAM,KAAK,YAAY,KAAK;gBAC1B,CAAC,CAAC,KAAK;gBACP,CAAC,CAAC,IAAI,KAAK,CAAC,6CAA6C,CAAC,CAAC;QAC/D,CAAC;QAED,IAAI,UAAU,GAAG,QAAQ,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,QAAQ,CAAC,EAAE,CAAC,CAAC;QAC9D,IAAI,UAAU,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;YAC1B,UAAU,GAAG,IAAI,UAAU,EAAE,CAAC;QAChC,CAAC;QACD,MAAM,SAAS,GAAG,KAAK,OAAO,CAAC,CAAC,GAAG,OAAO,CAAC,CAAC,GAAG,UAAU,EAAE,CAAC;QAC5D,MAAM,iBAAiB,GAAG,IAAA,oCAAqB,EAAC;YAC9C,IAAI;YACJ,SAAS;YACT,OAAO,EAAE,mCAAoB,CAAC,EAAE;SACjC,CAAC,CAAC;QAEH,IACE,OAAO,CAAC,iBAAiB,CAAC,iBAAiB,CAAC;YAC5C,OAAO,CAAC,iBAAiB,CAAC,WAAW,CAAC,EACtC,CAAC;YACD,MAAM,IAAI,KAAK,CAAC,sDAAsD,CAAC,CAAC;QAC1E,CAAC;QACD,OAAO,SAAS,CAAC;IACnB,CAAC;IAED,aAAa;QACX,MAAM,IAAI,KAAK,CAAC,8BAA8B,CAAC,CAAC;IAClD,CAAC;IAED,YAAY;QACV,IAAI,CAAC,QAAQ,GAAG,EAAE,CAAC;QACnB,IAAI,CAAC,QAAQ,GAAG,EAAE,CAAC;QACnB,IAAI,CAAC,IAAI,GAAG,CAAC,CAAC;QACd,IAAI,CAAC,eAAe,GAAG,CAAC,CAAC;QACzB,IAAI,CAAC,KAAK,GAAG,EAAE,CAAC;QAChB,IAAI,CAAC,cAAc,GAAG,EAAE,CAAC;QACzB,IAAI,CAAC,GAAG,GAAG,IAAI,eAAK,EAAE,CAAC;IACzB,CAAC;;AAleH,sCAslBC;+HA5fwB,IAAyC;IAC9D,IAAI,uBAAA,IAAI,mEAAoB,MAAxB,IAAI,CAAsB,IAAI,IAAI,CAAC,cAAc,EAAE,CAAC;QACtD,KAAK,MAAM,CAAC,OAAO,EAAE,KAAK,CAAC,IAAI,MAAM,CAAC,OAAO,CAAC,IAAI,CAAC,cAAc,CAAC,EAAE,CAAC;YACnE,IAAI,CAAC,cAAc,CAAC,OAAO,CAAC,GAAG;gBAC7B,KAAK,EAAE,IAAI;gBACX,MAAM,EAAE,uBAAA,IAAI,gEAAiB,MAArB,IAAI,EAAkB,KAAK,CAAC;aACrC,CAAC;QACJ,CAAC;IACH,CAAC;IACD,MAAM,IAAI,GAAG,IAAI,GAAG,CAAS,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,cAAc,CAAC,CAAC,CAAC;IAC/D,6CAA6C;IAC7C,IAAI,CAAC,uBAAA,IAAI,mEAAoB,MAAxB,IAAI,CAAsB,EAAE,CAAC;QAChC,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAC,OAAO,EAAE,EAAE;YAChC,MAAM,GAAG,GAAG,OAAO,CAAC,iBAAiB,CAAC,OAAO,CAAC,CAAC;YAE/C,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC,EAAE,CAAC;gBACnB,IAAI,CAAC,cAAc,CAAC,GAAG,CAAC,GAAG;oBACzB,KAAK,EAAE,KAAK;oBACZ,MAAM,EAAE,uBAAA,IAAI,gEAAiB,MAArB,IAAI,EAAkB,OAAO,CAAC;iBACvC,CAAC;YACJ,CAAC;QACH,CAAC,CAAC,CAAC;IACL,CAAC;AACH,CAAC,mCA+LD,KAAK,yCACH,OAAe,EACf,QAAgB,EAChB,aAE2C;IAE3C,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,sBAAsB,CAAC,OAAO,CAAC,CAAC;IAE1D,IAAI,CAAC,MAAM,EAAE,CAAC;QACZ,MAAM,IAAI,KAAK,CAAC,iDAAiD,CAAC,CAAC;IACrE,CAAC;IAED,IAAI,OAAO,CAAC;IACZ,IAAI,CAAC;QACH,OAAO,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,qBAAqB,CAAC;YAChD,EAAE,EAAE,QAAQ;YACZ,MAAM;SACP,CAAC,CAAC;IACL,CAAC;IAAC,OAAO,KAAK,EAAE,CAAC;QACf,MAAM,KAAK,YAAY,KAAK;YAC1B,CAAC,CAAC,KAAK;YACP,CAAC,CAAC,IAAI,KAAK,CAAC,iDAAiD,CAAC,CAAC;IACnE,CAAC;IAED,MAAM,cAAc,GAAG,aAAa,CAAC,OAAO,CAAC,CAAC;IAC9C,MAAM,KAAK,GAAG,cAAc,CAAC,eAAe,EAAE,CAAC;IAC/C,IAAI,KAAK,EAAE,CAAC;QACV,OAAO,cAAc,CAAC;IACxB,CAAC;IACD,MAAM,IAAI,KAAK,CAAC,gDAAgD,CAAC,CAAC;AACpE,CAAC;AAqJD,qBAAqB;AACrB,KAAK,iCAAU,SAAiB;IAC9B,IAAI,CAAC,IAAI,IAAI,SAAS,CAAC;IAEvB,IAAI,IAAI,CAAC,IAAI,IAAI,CAAC,EAAE,CAAC;QACnB,IAAI,CAAC,IAAI,GAAG,CAAC,CAAC;IAChB,CAAC;IACD,MAAM,IAAI,GAAG,CAAC,IAAI,CAAC,IAAI,GAAG,CAAC,CAAC,GAAG,IAAI,CAAC,OAAO,CAAC;IAC5C,MAAM,EAAE,GAAG,IAAI,GAAG,IAAI,CAAC,OAAO,CAAC;IAE/B,MAAM,IAAI,CAAC,MAAM,EAAE,CAAC;IACpB,IAAI,QAAQ,CAAC;IACb,IAAI,uBAAA,IAAI,mEAAoB,MAAxB,IAAI,CAAsB,EAAE,CAAC;QAC/B,QAAQ,GAAG,MAAM,uBAAA,IAAI,iEAAkB,MAAtB,IAAI,EAAmB,IAAI,EAAE,EAAE,CAAC,CAAC;IACpD,CAAC;SAAM,CAAC;QACN,QAAQ,GAAG,uBAAA,IAAI,kEAAmB,MAAvB,IAAI,EAAoB,IAAI,EAAE,EAAE,CAAC,CAAC;IAC/C,CAAC;IACD,OAAO,QAAQ,CAAC;AAClB,CAAC,oCAED,KAAK,0CAAmB,IAAY,EAAE,EAAU;IAC9C,MAAM,QAAQ,GAAgB,EAAE,CAAC;IAEjC,KAAK,IAAI,CAAC,GAAG,IAAI,EAAE,CAAC,GAAG,EAAE,EAAE,CAAC,EAAE,EAAE,CAAC;QAC/B,MAAM,IAAI,GAAG,uBAAA,IAAI,gEAAiB,MAArB,IAAI,EAAkB,CAAC,CAAC,CAAC;QACtC,MAAM,OAAO,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;QACxC,MAAM,KAAK,GAAG,IAAI,CAAC,kBAAkB;YACnC,CAAC,CAAC,MAAM,uBAAA,IAAI,wEAAyB,MAA7B,IAAI,EAA0B,OAAO,CAAC;YAC9C,CAAC,CAAC,IAAI,CAAC;QACT,QAAQ,CAAC,IAAI,CAAC;YACZ,OAAO;YACP,OAAO,EAAE,IAAI;YACb,KAAK,EAAE,CAAC;SACT,CAAC,CAAC;QAEH,YAAY;QACZ,uDAAuD;QACvD,yDAAyD;QACzD,0DAA0D;QAC1D,IAAI,CAAC,KAAK,EAAE,CAAC;YACX,MAAM;QACR,CAAC;IACH,CAAC;IACD,OAAO,QAAQ,CAAC;AAClB,CAAC,+EAEkB,IAAY,EAAE,EAAU;IACzC,MAAM,QAAQ,GAAgB,EAAE,CAAC;IAEjC,KAAK,IAAI,CAAC,GAAG,IAAI,EAAE,CAAC,GAAG,EAAE,EAAE,CAAC,EAAE,EAAE,CAAC;QAC/B,MAAM,OAAO,GAAG,uBAAA,IAAI,iEAAkB,MAAtB,IAAI,EAAmB,QAAQ,EAAE,CAAC,CAAC,CAAC;QACpD,QAAQ,CAAC,IAAI,CAAC;YACZ,OAAO;YACP,OAAO,EAAE,IAAI;YACb,KAAK,EAAE,CAAC;SACT,CAAC,CAAC;QACH,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,iBAAiB,CAAC,OAAO,CAAC,CAAC,GAAG,CAAC,CAAC;IACrD,CAAC;IACD,OAAO,QAAQ,CAAC;AAClB,CAAC,6EAEiB,QAAgB,EAAE,CAAS;IAC3C,MAAM,IAAI,GAAG,IAAI,CAAC,GAAG,CAAC,MAAM,CAAC,GAAG,QAAQ,IAAI,CAAC,EAAE,CAAC,CAAC;IACjD,MAAM,OAAO,GAAG,OAAO;SACpB,eAAe,CAAC,IAAI,CAAC,SAAS,EAAE,IAAI,CAAC;SACrC,QAAQ,CAAC,KAAK,CAAC,CAAC;IACnB,OAAO,OAAO,CAAC,iBAAiB,CAAC,KAAK,OAAO,EAAE,CAAC,CAAC;AACnD,CAAC,2EAEgB,OAAe;IAC9B,MAAM,kBAAkB,GAAG,OAAO,CAAC,iBAAiB,CAAC,OAAO,CAAC,CAAC;IAC9D,IAAI,KAAK,GAAG,IAAI,CAAC,KAAK,CAAC,kBAAkB,CAAC,CAAC;IAC3C,IAAI,OAAO,KAAK,KAAK,WAAW,EAAE,CAAC;QACjC,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,SAAS,EAAE,CAAC,EAAE,EAAE,CAAC;YACnC,IAAI,kBAAkB,KAAK,uBAAA,IAAI,iEAAkB,MAAtB,IAAI,EAAmB,QAAQ,EAAE,CAAC,CAAC,EAAE,CAAC;gBAC/D,KAAK,GAAG,CAAC,CAAC;gBACV,MAAM;YACR,CAAC;QACH,CAAC;IACH,CAAC;IAED,IAAI,OAAO,KAAK,KAAK,WAAW,EAAE,CAAC;QACjC,MAAM,IAAI,KAAK,CAAC,iBAAiB,CAAC,CAAC;IACrC,CAAC;IACD,OAAO,uBAAA,IAAI,gEAAiB,MAArB,IAAI,EAAkB,KAAK,CAAC,CAAC;AACtC,CAAC,2EAEgB,KAAa;IAC5B,4CAA4C;IAC5C,OAAO,uBAAA,IAAI,mEAAoB,MAAxB,IAAI,CAAsB;QAC/B,CAAC,CAAC,aAAa,KAAK,OAAO;QAC3B,CAAC,CAAC,GAAG,IAAI,CAAC,MAAM,IAAI,KAAK,EAAE,CAAC;AAChC,CAAC;IAGC,OAAO,IAAI,CAAC,MAAM,KAAK,kBAAkB,CAAC;AAC5C,CAAC,qEAEa,IAAY;IACxB,OAAO,IAAI,CAAC,QAAQ,EAAE,CAAC,OAAO,CAAC,IAAI,EAAE,EAAE,CAAC,CAAC;AAC3C,CAAC,2CAED,KAAK,iDAA0B,OAAe;IAC5C,MAAM,MAAM,GAAG,uBAAA,IAAI,0DAAW,MAAf,IAAI,CAAa,CAAC;IACjC,MAAM,QAAQ,GAAG,MAAM,MAAM,CAAC,KAAK,CACjC,GAAG,MAAM,6CAA6C,OAAO,6BAA6B,CAC3F,CAAC;IACF,MAAM,cAAc,GAAG,MAAM,QAAQ,CAAC,IAAI,EAAE,CAAC;IAC7C,OAAO,cAAc,CAAC,MAAM,KAAK,GAAG,IAAI,cAAc,CAAC,MAAM,CAAC,MAAM,GAAG,CAAC,CAAC;AAC3E,CAAC;IAGC,OAAO,IAAI,CAAC,OAAO,CAAC;AACtB,CAAC;AAplBM,kBAAI,GAAW,WAAW,AAAtB,CAAuB","sourcesContent":["import { RLP } from '@ethereumjs/rlp';\nimport { TransactionFactory, TxData, TypedTransaction } from '@ethereumjs/tx';\nimport * as ethUtil from '@ethereumjs/util';\nimport type { MessageTypes, TypedMessage } from '@metamask/eth-sig-util';\nimport {\n  recoverPersonalSignature,\n  recoverTypedSignature,\n  SignTypedDataVersion,\n  TypedDataUtils,\n} from '@metamask/eth-sig-util';\nimport { Buffer } from 'buffer';\nimport type OldEthJsTransaction from 'ethereumjs-tx';\nimport { EventEmitter } from 'events';\nimport HDKey from 'hdkey';\n\nimport { LedgerBridge, LedgerBridgeOptions } from './ledger-bridge';\nimport { LedgerIframeBridgeOptions } from './ledger-iframe-bridge';\n\nconst pathBase = 'm';\nconst hdPathString = `${pathBase}/44'/60'/0'`;\nconst keyringType = 'Ledger Hardware';\n\n// This number causes one of our failing tests to run very slowly, as the for loop needs to iterate 1000 times.\nconst MAX_INDEX = 1000;\n\nenum NetworkApiUrls {\n  Ropsten = 'https://api-ropsten.etherscan.io',\n  Kovan = 'https://api-kovan.etherscan.io',\n  Rinkeby = 'https://api-rinkeby.etherscan.io',\n  Mainnet = `https://api.etherscan.io`,\n}\n\ntype SignTransactionPayload = Awaited<\n  ReturnType<LedgerBridge<LedgerIframeBridgeOptions>['deviceSignTransaction']>\n>;\n\nexport type AccountPageEntry = {\n  address: string;\n  balance: number | null;\n  index: number;\n};\n\nexport type AccountPage = AccountPageEntry[];\n\nexport type AccountDetails = {\n  index?: number;\n  bip44?: boolean;\n  hdPath?: string;\n};\n\nexport type LedgerBridgeKeyringOptions = {\n  hdPath: string;\n  accounts: readonly string[];\n  deviceId: string;\n  accountDetails: Readonly<Record<string, AccountDetails>>;\n  accountIndexes: Readonly<Record<string, number>>;\n  implementFullBIP44: boolean;\n};\n\n/**\n * Check if the given transaction is made with ethereumjs-tx or @ethereumjs/tx\n *\n * Transactions built with older versions of ethereumjs-tx have a\n * getChainId method that newer versions do not.\n * Older versions are mutable\n * while newer versions default to being immutable.\n * Expected shape and type\n * of data for v, r and s differ (Buffer (old) vs BN (new)).\n *\n * @param tx - Transaction to check, instance of either ethereumjs-tx or @ethereumjs/tx.\n * @returns Returns `true` if tx is an old-style ethereumjs-tx transaction.\n */\nfunction isOldStyleEthereumjsTx(\n  tx: TypedTransaction | OldEthJsTransaction,\n): tx is OldEthJsTransaction {\n  return 'getChainId' in tx && typeof tx.getChainId === 'function';\n}\n\nexport class LedgerKeyring extends EventEmitter {\n  static type: string = keyringType;\n\n  deviceId = '';\n\n  readonly type: string = keyringType;\n\n  page = 0;\n\n  perPage = 5;\n\n  unlockedAccount = 0;\n\n  accounts: readonly string[] = [];\n\n  accountDetails: Record<string, AccountDetails> = {};\n\n  hdk = new HDKey();\n\n  hdPath = hdPathString;\n\n  paths: Record<string, number> = {};\n\n  network: NetworkApiUrls = NetworkApiUrls.Mainnet;\n\n  implementFullBIP44 = false;\n\n  bridge: LedgerBridge<LedgerBridgeOptions>;\n\n  constructor({ bridge }: { bridge: LedgerBridge<LedgerBridgeOptions> }) {\n    super();\n\n    if (!bridge) {\n      throw new Error('Bridge is a required dependency for the keyring');\n    }\n\n    this.bridge = bridge;\n  }\n\n  async init(): Promise<void> {\n    return this.bridge.init();\n  }\n\n  async destroy(): Promise<void> {\n    return this.bridge.destroy();\n  }\n\n  async serialize(): Promise<\n    Partial<LedgerBridgeKeyringOptions> // Maybe we should have a proper \"state\" type here instead of using this \"options\" type.\n  > {\n    return {\n      hdPath: this.hdPath,\n      accounts: this.accounts,\n      deviceId: this.deviceId,\n      accountDetails: this.accountDetails,\n      implementFullBIP44: false,\n    };\n  }\n\n  async deserialize(\n    opts: Partial<LedgerBridgeKeyringOptions> = {}, // Same question here?\n  ): Promise<void> {\n    this.hdPath = opts.hdPath ?? hdPathString;\n    this.accounts = opts.accounts ?? [];\n    this.deviceId = opts.deviceId ?? '';\n    this.accountDetails = opts.accountDetails ?? {};\n\n    if (!opts.accountDetails) {\n      this.#migrateAccountDetails(opts);\n    }\n\n    this.implementFullBIP44 = opts.implementFullBIP44 ?? false;\n\n    const keys = new Set<string>(Object.keys(this.accountDetails));\n    // Remove accounts that don't have corresponding account details\n    this.accounts = this.accounts.filter((account) =>\n      keys.has(ethUtil.toChecksumAddress(account)),\n    );\n\n    return Promise.resolve();\n  }\n\n  public setDeviceId(deviceId: string): void {\n    this.deviceId = deviceId;\n  }\n\n  public getDeviceId(): string {\n    return this.deviceId;\n  }\n\n  #migrateAccountDetails(opts: Partial<LedgerBridgeKeyringOptions>): void {\n    if (this.#isLedgerLiveHdPath() && opts.accountIndexes) {\n      for (const [account, index] of Object.entries(opts.accountIndexes)) {\n        this.accountDetails[account] = {\n          bip44: true,\n          hdPath: this.#getPathForIndex(index),\n        };\n      }\n    }\n    const keys = new Set<string>(Object.keys(this.accountDetails));\n    // try to migrate non-LedgerLive accounts too\n    if (!this.#isLedgerLiveHdPath()) {\n      this.accounts.forEach((account) => {\n        const key = ethUtil.toChecksumAddress(account);\n\n        if (!keys.has(key)) {\n          this.accountDetails[key] = {\n            bip44: false,\n            hdPath: this.#pathFromAddress(account),\n          };\n        }\n      });\n    }\n  }\n\n  isUnlocked(): boolean {\n    return Boolean(this.hdk.publicKey);\n  }\n\n  isConnected(): boolean {\n    return this.bridge.isDeviceConnected;\n  }\n\n  setAccountToUnlock(index: number): void {\n    this.unlockedAccount = index;\n  }\n\n  setHdPath(hdPath: string): void {\n    // Reset HDKey if the path changes\n    if (this.hdPath !== hdPath) {\n      this.hdk = new HDKey();\n    }\n    this.hdPath = hdPath;\n  }\n\n  async unlock(hdPath?: string, updateHdk = true): Promise<string> {\n    if (this.isUnlocked() && !hdPath) {\n      return 'already unlocked';\n    }\n    const path = hdPath ? this.#toLedgerPath(hdPath) : this.hdPath;\n\n    let payload;\n    try {\n      payload = await this.bridge.getPublicKey({\n        hdPath: path,\n      });\n    } catch (error) {\n      throw error instanceof Error\n        ? error\n        : new Error('Ledger Ethereum app closed. Open it to unlock.');\n    }\n\n    if (updateHdk && payload.chainCode) {\n      this.hdk.publicKey = Buffer.from(payload.publicKey, 'hex');\n      this.hdk.chainCode = Buffer.from(payload.chainCode, 'hex');\n    }\n\n    return payload.address;\n  }\n\n  async addAccounts(amount = 1): Promise<string[]> {\n    return new Promise((resolve, reject) => {\n      this.unlock()\n        .then(async (_) => {\n          const from = this.unlockedAccount;\n          const to = from + amount;\n          const newAccounts: string[] = [];\n          for (let i = from; i < to; i++) {\n            const path = this.#getPathForIndex(i);\n            let address;\n            if (this.#isLedgerLiveHdPath()) {\n              address = await this.unlock(path);\n            } else {\n              address = this.#addressFromIndex(pathBase, i);\n            }\n\n            this.accountDetails[ethUtil.toChecksumAddress(address)] = {\n              // TODO: consider renaming this property, as the current name is misleading\n              // It's currently used to represent whether an account uses the Ledger Live path.\n              bip44: this.#isLedgerLiveHdPath(),\n              hdPath: path,\n            };\n\n            if (!this.accounts.includes(address)) {\n              this.accounts = [...this.accounts, address];\n              newAccounts.push(address);\n            }\n            this.page = 0;\n          }\n          resolve(newAccounts);\n        })\n        .catch(reject);\n    });\n  }\n\n  getName(): string {\n    return keyringType;\n  }\n\n  async getFirstPage(): Promise<AccountPage> {\n    this.page = 0;\n    return this.#getPage(1);\n  }\n\n  async getNextPage(): Promise<AccountPage> {\n    return this.#getPage(1);\n  }\n\n  async getPreviousPage(): Promise<AccountPage> {\n    return this.#getPage(-1);\n  }\n\n  async getAccounts(): Promise<string[]> {\n    return Promise.resolve(this.accounts.slice());\n  }\n\n  removeAccount(address: string): void {\n    const filteredAccounts = this.accounts.filter(\n      (a) => a.toLowerCase() !== address.toLowerCase(),\n    );\n\n    if (filteredAccounts.length === this.accounts.length) {\n      throw new Error(`Address ${address} not found in this keyring`);\n    }\n\n    this.accounts = filteredAccounts;\n    delete this.accountDetails[ethUtil.toChecksumAddress(address)];\n  }\n\n  async attemptMakeApp(): Promise<boolean> {\n    return this.bridge.attemptMakeApp();\n  }\n\n  async updateTransportMethod(transportType: string): Promise<boolean> {\n    return this.bridge.updateTransportMethod(transportType);\n  }\n\n  // tx is an instance of the ethereumjs-transaction class.\n  async signTransaction(\n    address: string,\n    tx: TypedTransaction | OldEthJsTransaction,\n  ): Promise<TypedTransaction | OldEthJsTransaction> {\n    let rawTxHex;\n    // transactions built with older versions of ethereumjs-tx have a\n    // getChainId method that newer versions do not. Older versions are mutable\n    // while newer versions default to being immutable. Expected shape and type\n    // of data for v, r and s differ (Buffer (old) vs BN (new))\n    if (isOldStyleEthereumjsTx(tx)) {\n      // In this version of ethereumjs-tx we must add the chainId in hex format\n      // to the initial v value. The chainId must be included in the serialized\n      // transaction which is only communicated to ethereumjs-tx in this\n      // value. In newer versions the chainId is communicated via the 'Common'\n      // object.\n      // @ts-expect-error tx.v should be a Buffer, but we are assigning a string\n      tx.v = ethUtil.bufferToHex(tx.getChainId());\n      // @ts-expect-error tx.r should be a Buffer, but we are assigning a string\n      tx.r = '0x00';\n      // @ts-expect-error tx.s should be a Buffer, but we are assigning a string\n      tx.s = '0x00';\n\n      rawTxHex = tx.serialize().toString('hex');\n\n      return this.#signTransaction(address, rawTxHex, (payload) => {\n        tx.v = Buffer.from(payload.v, 'hex');\n        tx.r = Buffer.from(payload.r, 'hex');\n        tx.s = Buffer.from(payload.s, 'hex');\n        return tx;\n      });\n    }\n\n    // The below `encode` call is only necessary for legacy transactions, as `getMessageToSign`\n    // calls `rlp.encode` internally for non-legacy transactions. As per the \"Transaction Execution\"\n    // section of the ethereum yellow paper, transactions need to be \"well-formed RLP, with no additional\n    // trailing bytes\".\n\n    // Note also that `getMessageToSign` will return valid RLP for all transaction types, whereas the\n    // `serialize` method will not for any transaction type except legacy. This is because `serialize` includes\n    // empty r, s and v values in the encoded rlp. This is why we use `getMessageToSign` here instead of `serialize`.\n    const messageToSign = tx.getMessageToSign(false);\n\n    rawTxHex = Buffer.isBuffer(messageToSign)\n      ? messageToSign.toString('hex')\n      : Buffer.from(RLP.encode(messageToSign)).toString('hex');\n\n    return this.#signTransaction(address, rawTxHex, (payload) => {\n      // Because tx will be immutable, first get a plain javascript object that\n      // represents the transaction. Using txData here as it aligns with the\n      // nomenclature of ethereumjs/tx.\n      const txData: TxData = tx.toJSON();\n      // The fromTxData utility expects a type to support transactions with a type other than 0\n      txData.type = tx.type;\n      // The fromTxData utility expects v,r and s to be hex prefixed\n      txData.v = ethUtil.addHexPrefix(payload.v);\n      txData.r = ethUtil.addHexPrefix(payload.r);\n      txData.s = ethUtil.addHexPrefix(payload.s);\n      // Adopt the 'common' option from the original transaction and set the\n      // returned object to be frozen if the original is frozen.\n      return TransactionFactory.fromTxData(txData, {\n        common: tx.common,\n        freeze: Object.isFrozen(tx),\n      });\n    });\n  }\n\n  async #signTransaction(\n    address: string,\n    rawTxHex: string,\n    handleSigning: (\n      payload: SignTransactionPayload,\n    ) => TypedTransaction | OldEthJsTransaction,\n  ): Promise<TypedTransaction | OldEthJsTransaction> {\n    const hdPath = await this.unlockAccountByAddress(address);\n\n    if (!hdPath) {\n      throw new Error('Ledger: Unknown error while signing transaction');\n    }\n\n    let payload;\n    try {\n      payload = await this.bridge.deviceSignTransaction({\n        tx: rawTxHex,\n        hdPath,\n      });\n    } catch (error) {\n      throw error instanceof Error\n        ? error\n        : new Error('Ledger: Unknown error while signing transaction');\n    }\n\n    const newOrMutatedTx = handleSigning(payload);\n    const valid = newOrMutatedTx.verifySignature();\n    if (valid) {\n      return newOrMutatedTx;\n    }\n    throw new Error('Ledger: The transaction signature is not valid');\n  }\n\n  async signMessage(withAccount: string, data: string): Promise<string> {\n    return this.signPersonalMessage(withAccount, data);\n  }\n\n  // For personal_sign, we need to prefix the message:\n  async signPersonalMessage(\n    withAccount: string,\n    message: string,\n  ): Promise<string> {\n    const hdPath = await this.unlockAccountByAddress(withAccount);\n\n    if (!hdPath) {\n      throw new Error('Ledger: Unknown error while signing message');\n    }\n\n    let payload;\n    try {\n      payload = await this.bridge.deviceSignMessage({\n        hdPath,\n        message: ethUtil.stripHexPrefix(message),\n      });\n    } catch (error) {\n      throw error instanceof Error\n        ? error\n        : new Error('Ledger: Unknown error while signing message');\n    }\n\n    let modifiedV = parseInt(String(payload.v), 10).toString(16);\n    if (modifiedV.length < 2) {\n      modifiedV = `0${modifiedV}`;\n    }\n\n    const signature = `0x${payload.r}${payload.s}${modifiedV}`;\n    const addressSignedWith = recoverPersonalSignature({\n      data: message,\n      signature,\n    });\n    if (\n      ethUtil.toChecksumAddress(addressSignedWith) !==\n      ethUtil.toChecksumAddress(withAccount)\n    ) {\n      throw new Error('Ledger: The signature doesnt match the right address');\n    }\n    return signature;\n  }\n\n  async unlockAccountByAddress(address: string): Promise<string | undefined> {\n    const checksummedAddress = ethUtil.toChecksumAddress(address);\n    const accountDetails = this.accountDetails[checksummedAddress];\n    if (!accountDetails) {\n      throw new Error(\n        `Ledger: Account for address '${checksummedAddress}' not found`,\n      );\n    }\n    const { hdPath } = accountDetails;\n    const unlockedAddress = await this.unlock(hdPath, false);\n\n    // unlock resolves to the address for the given hdPath as reported by the ledger device\n    // if that address is not the requested address, then this account belongs to a different device or seed\n    if (unlockedAddress.toLowerCase() !== address.toLowerCase()) {\n      throw new Error(\n        `Ledger: Account ${address} does not belong to the connected device`,\n      );\n    }\n    return hdPath;\n  }\n\n  async signTypedData<T extends MessageTypes>(\n    withAccount: string,\n    data: TypedMessage<T>,\n    options: { version?: string } = {},\n  ): Promise<string> {\n    const isV4 = options.version === 'V4';\n    if (!isV4) {\n      throw new Error(\n        'Ledger: Only version 4 of typed data signing is supported',\n      );\n    }\n\n    const { domain, types, primaryType, message } =\n      TypedDataUtils.sanitizeData(data);\n\n    const hdPath = await this.unlockAccountByAddress(withAccount);\n\n    if (!hdPath) {\n      throw new Error('Ledger: Unknown error while signing message');\n    }\n\n    const pt = primaryType.toString();\n\n    let payload;\n    try {\n      payload = await this.bridge.deviceSignTypedData({\n        hdPath,\n        message: {\n          domain: {\n            name: domain.name,\n            chainId: domain.chainId,\n            version: domain.version,\n            verifyingContract: domain.verifyingContract,\n            salt: domain.salt? new TextDecoder().decode(domain.salt): undefined,\n          },\n          types,\n          primaryType: pt,\n          message,\n        },\n      });\n    } catch (error) {\n      throw error instanceof Error\n        ? error\n        : new Error('Ledger: Unknown error while signing message');\n    }\n\n    let recoveryId = parseInt(String(payload.v), 10).toString(16);\n    if (recoveryId.length < 2) {\n      recoveryId = `0${recoveryId}`;\n    }\n    const signature = `0x${payload.r}${payload.s}${recoveryId}`;\n    const addressSignedWith = recoverTypedSignature({\n      data,\n      signature,\n      version: SignTypedDataVersion.V4,\n    });\n\n    if (\n      ethUtil.toChecksumAddress(addressSignedWith) !==\n      ethUtil.toChecksumAddress(withAccount)\n    ) {\n      throw new Error('Ledger: The signature doesnt match the right address');\n    }\n    return signature;\n  }\n\n  exportAccount(): void {\n    throw new Error('Not supported on this device');\n  }\n\n  forgetDevice(): void {\n    this.deviceId = '';\n    this.accounts = [];\n    this.page = 0;\n    this.unlockedAccount = 0;\n    this.paths = {};\n    this.accountDetails = {};\n    this.hdk = new HDKey();\n  }\n\n  /* PRIVATE METHODS */\n  async #getPage(increment: number): Promise<AccountPage> {\n    this.page += increment;\n\n    if (this.page <= 0) {\n      this.page = 1;\n    }\n    const from = (this.page - 1) * this.perPage;\n    const to = from + this.perPage;\n\n    await this.unlock();\n    let accounts;\n    if (this.#isLedgerLiveHdPath()) {\n      accounts = await this.#getAccountsBIP44(from, to);\n    } else {\n      accounts = this.#getAccountsLegacy(from, to);\n    }\n    return accounts;\n  }\n\n  async #getAccountsBIP44(from: number, to: number): Promise<AccountPage> {\n    const accounts: AccountPage = [];\n\n    for (let i = from; i < to; i++) {\n      const path = this.#getPathForIndex(i);\n      const address = await this.unlock(path);\n      const valid = this.implementFullBIP44\n        ? await this.#hasPreviousTransactions(address)\n        : true;\n      accounts.push({\n        address,\n        balance: null,\n        index: i,\n      });\n\n      // PER BIP44\n      // \"Software should prevent a creation of an account if\n      // a previous account does not have a transaction history\n      // (meaning none of its addresses have been used before).\"\n      if (!valid) {\n        break;\n      }\n    }\n    return accounts;\n  }\n\n  #getAccountsLegacy(from: number, to: number): AccountPage {\n    const accounts: AccountPage = [];\n\n    for (let i = from; i < to; i++) {\n      const address = this.#addressFromIndex(pathBase, i);\n      accounts.push({\n        address,\n        balance: null,\n        index: i,\n      });\n      this.paths[ethUtil.toChecksumAddress(address)] = i;\n    }\n    return accounts;\n  }\n\n  #addressFromIndex(basePath: string, i: number): string {\n    const dkey = this.hdk.derive(`${basePath}/${i}`);\n    const address = ethUtil\n      .publicToAddress(dkey.publicKey, true)\n      .toString('hex');\n    return ethUtil.toChecksumAddress(`0x${address}`);\n  }\n\n  #pathFromAddress(address: string): string {\n    const checksummedAddress = ethUtil.toChecksumAddress(address);\n    let index = this.paths[checksummedAddress];\n    if (typeof index === 'undefined') {\n      for (let i = 0; i < MAX_INDEX; i++) {\n        if (checksummedAddress === this.#addressFromIndex(pathBase, i)) {\n          index = i;\n          break;\n        }\n      }\n    }\n\n    if (typeof index === 'undefined') {\n      throw new Error('Unknown address');\n    }\n    return this.#getPathForIndex(index);\n  }\n\n  #getPathForIndex(index: number): string {\n    // Check if the path is BIP 44 (Ledger Live)\n    return this.#isLedgerLiveHdPath()\n      ? `m/44'/60'/${index}'/0/0`\n      : `${this.hdPath}/${index}`;\n  }\n\n  #isLedgerLiveHdPath(): boolean {\n    return this.hdPath === `m/44'/60'/0'/0/0`;\n  }\n\n  #toLedgerPath(path: string): string {\n    return path.toString().replace('m/', '');\n  }\n\n  async #hasPreviousTransactions(address: string): Promise<boolean> {\n    const apiUrl = this.#getApiUrl();\n    const response = await window.fetch(\n      `${apiUrl}/api?module=account&action=txlist&address=${address}&tag=latest&page=1&offset=1`,\n    );\n    const parsedResponse = await response.json();\n    return parsedResponse.status !== '0' && parsedResponse.result.length > 0;\n  }\n\n  #getApiUrl(): NetworkApiUrls {\n    return this.network;\n  }\n}\n"]}
\ No newline at end of file
diff --git a/node_modules/@metamask/eth-ledger-bridge-keyring/dist/ledger-mobile-bridge.d.ts b/node_modules/@metamask/eth-ledger-bridge-keyring/dist/ledger-mobile-bridge.d.ts
index d5ed93b..b094d70 100644
--- a/node_modules/@metamask/eth-ledger-bridge-keyring/dist/ledger-mobile-bridge.d.ts
+++ b/node_modules/@metamask/eth-ledger-bridge-keyring/dist/ledger-mobile-bridge.d.ts
@@ -42,11 +42,10 @@ export declare class LedgerMobileBridge implements MobileBridge {
      *
      * @param params - An object contains hdPath, domainSeparatorHex and hashStructMessageHex.
      * @param params.hdPath - The BIP 32 path of the account.
-     * @param params.domainSeparatorHex - The domain separator.
-     * @param params.hashStructMessageHex - The hashed struct message.
+     * @param params.message - The EIP712 message to sign.
      * @returns Retrieve v, r, s from the signed message.
      */
-    deviceSignTypedData({ hdPath, domainSeparatorHex, hashStructMessageHex, }: LedgerSignTypedDataParams): Promise<LedgerSignTypedDataResponse>;
+    deviceSignTypedData({ hdPath, message, }: LedgerSignTypedDataParams): Promise<LedgerSignTypedDataResponse>;
     /**
      * Method to sign a transaction
      * Sending the hexadecimal transaction message to the device and returning the signed transaction.
diff --git a/node_modules/@metamask/eth-ledger-bridge-keyring/dist/ledger-mobile-bridge.js b/node_modules/@metamask/eth-ledger-bridge-keyring/dist/ledger-mobile-bridge.js
index bd1c412..2e3ee19 100644
--- a/node_modules/@metamask/eth-ledger-bridge-keyring/dist/ledger-mobile-bridge.js
+++ b/node_modules/@metamask/eth-ledger-bridge-keyring/dist/ledger-mobile-bridge.js
@@ -10,13 +10,9 @@ var __classPrivateFieldGet = (this && this.__classPrivateFieldGet) || function (
     if (typeof state === "function" ? receiver !== state || !f : !state.has(receiver)) throw new TypeError("Cannot read private member from an object whose class did not declare it");
     return kind === "m" ? f : kind === "a" ? f.call(receiver) : f ? f.value : state.get(receiver);
 };
-var __importDefault = (this && this.__importDefault) || function (mod) {
-    return (mod && mod.__esModule) ? mod : { "default": mod };
-};
 var _LedgerMobileBridge_instances, _LedgerMobileBridge_transportMiddleware, _LedgerMobileBridge_opts, _LedgerMobileBridge_getTransportMiddleWare, _LedgerMobileBridge_getEthApp;
 Object.defineProperty(exports, "__esModule", { value: true });
 exports.LedgerMobileBridge = void 0;
-const ledger_1 = __importDefault(require("@ledgerhq/hw-app-eth/lib/services/ledger"));
 /**
  * LedgerMobileBridge is a bridge between the LedgerKeyring and the LedgerTransportMiddleware.
  */
@@ -70,12 +66,11 @@ class LedgerMobileBridge {
      *
      * @param params - An object contains hdPath, domainSeparatorHex and hashStructMessageHex.
      * @param params.hdPath - The BIP 32 path of the account.
-     * @param params.domainSeparatorHex - The domain separator.
-     * @param params.hashStructMessageHex - The hashed struct message.
+     * @param params.message - The EIP712 message to sign.
      * @returns Retrieve v, r, s from the signed message.
      */
-    async deviceSignTypedData({ hdPath, domainSeparatorHex, hashStructMessageHex, }) {
-        return __classPrivateFieldGet(this, _LedgerMobileBridge_instances, "m", _LedgerMobileBridge_getEthApp).call(this).signEIP712HashedMessage(hdPath, domainSeparatorHex, hashStructMessageHex);
+    async deviceSignTypedData({ hdPath, message, }) {
+        return __classPrivateFieldGet(this, _LedgerMobileBridge_instances, "m", _LedgerMobileBridge_getEthApp).call(this).signEIP712Message(hdPath, message);
     }
     /**
      * Method to sign a transaction
@@ -87,8 +82,12 @@ class LedgerMobileBridge {
      * @returns Retrieve v, r, s from the signed transaction.
      */
     async deviceSignTransaction({ tx, hdPath, }) {
-        const resolution = await ledger_1.default.resolveTransaction(tx, {}, {});
-        return __classPrivateFieldGet(this, _LedgerMobileBridge_instances, "m", _LedgerMobileBridge_getEthApp).call(this).signTransaction(hdPath, tx, resolution);
+        const ethApp = __classPrivateFieldGet(this, _LedgerMobileBridge_instances, "m", _LedgerMobileBridge_getEthApp).call(this);
+        return ethApp.clearSignTransaction(hdPath, tx, {
+            externalPlugins: true,
+            erc20: true,
+            nft: true,
+        });
     }
     /**
      * Method to retrieve the ethereum address for a given BIP 32 path.
diff --git a/node_modules/@metamask/eth-ledger-bridge-keyring/dist/ledger-mobile-bridge.js.map b/node_modules/@metamask/eth-ledger-bridge-keyring/dist/ledger-mobile-bridge.js.map
index 875fe5b..af9b887 100644
--- a/node_modules/@metamask/eth-ledger-bridge-keyring/dist/ledger-mobile-bridge.js.map
+++ b/node_modules/@metamask/eth-ledger-bridge-keyring/dist/ledger-mobile-bridge.js.map
@@ -1 +1 @@
-{"version":3,"file":"ledger-mobile-bridge.js","sourceRoot":"","sources":["../src/ledger-mobile-bridge.ts"],"names":[],"mappings":"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","sourcesContent":["import ledgerService from '@ledgerhq/hw-app-eth/lib/services/ledger';\nimport type Transport from '@ledgerhq/hw-transport';\n\nimport {\n  GetPublicKeyParams,\n  GetPublicKeyResponse,\n  LedgerBridge,\n  LedgerSignMessageParams,\n  LedgerSignMessageResponse,\n  LedgerSignTransactionParams,\n  LedgerSignTransactionResponse,\n  LedgerSignTypedDataParams,\n  LedgerSignTypedDataResponse,\n} from './ledger-bridge';\nimport { MetaMaskLedgerHwAppEth } from './ledger-hw-app';\nimport { TransportMiddleware } from './ledger-transport-middleware';\nimport {\n  GetAppNameAndVersionResponse,\n  LedgerMobileBridgeOptions,\n} from './type';\n\n// MobileBridge Type will always use LedgerBridge with LedgerMobileBridgeOptions\nexport type MobileBridge = LedgerBridge<LedgerMobileBridgeOptions> & {\n  getAppNameAndVersion(): Promise<GetAppNameAndVersionResponse>;\n  openEthApp(): Promise<void>;\n  closeApps(): Promise<void>;\n};\n\n/**\n * LedgerMobileBridge is a bridge between the LedgerKeyring and the LedgerTransportMiddleware.\n */\nexport class LedgerMobileBridge implements MobileBridge {\n  readonly #transportMiddleware?: TransportMiddleware;\n\n  #opts: LedgerMobileBridgeOptions;\n\n  isDeviceConnected = false;\n\n  constructor(\n    transportMiddleware: TransportMiddleware,\n    opts: LedgerMobileBridgeOptions = {},\n  ) {\n    this.#opts = opts;\n    this.#transportMiddleware = transportMiddleware;\n  }\n\n  /**\n   * Method to initializes the keyring.\n   * Mobile ledger doesnt not require init.\n   *\n   * @returns A promise that will resolve once the bridge is initialized.\n   */\n  async init(): Promise<void> {\n    return Promise.resolve();\n  }\n\n  /**\n   * Method to destroy the keyring.\n   * It will dispose the transportmiddleware and set isDeviceConnected to false.\n   */\n  async destroy(): Promise<void> {\n    try {\n      await this.#getTransportMiddleWare().dispose();\n    } catch (error) {\n      // eslint-disable-next-line no-console\n      console.error(error);\n    }\n    this.isDeviceConnected = false;\n  }\n\n  /**\n   * Method to sign a string Message.\n   * Sending the string message to the device and returning the signed message.\n   *\n   * @param params - An object contains hdPath and message.\n   * @param params.hdPath - The BIP 32 path of the account.\n   * @param params.message - The message to sign.\n   * @returns Retrieve v, r, s from the signed message.\n   */\n  async deviceSignMessage({\n    hdPath,\n    message,\n  }: LedgerSignMessageParams): Promise<LedgerSignMessageResponse> {\n    return this.#getEthApp().signPersonalMessage(hdPath, message);\n  }\n\n  /**\n   * Method to sign a EIP712 Message.\n   * Sending the typed data message to the device and returning the signed message.\n   *\n   * @param params - An object contains hdPath, domainSeparatorHex and hashStructMessageHex.\n   * @param params.hdPath - The BIP 32 path of the account.\n   * @param params.domainSeparatorHex - The domain separator.\n   * @param params.hashStructMessageHex - The hashed struct message.\n   * @returns Retrieve v, r, s from the signed message.\n   */\n  async deviceSignTypedData({\n    hdPath,\n    domainSeparatorHex,\n    hashStructMessageHex,\n  }: LedgerSignTypedDataParams): Promise<LedgerSignTypedDataResponse> {\n    return this.#getEthApp().signEIP712HashedMessage(\n      hdPath,\n      domainSeparatorHex,\n      hashStructMessageHex,\n    );\n  }\n\n  /**\n   * Method to sign a transaction\n   * Sending the hexadecimal transaction message to the device and returning the signed transaction.\n   *\n   * @param params - An object contains tx, hdPath.\n   * @param params.tx - The raw ethereum transaction in hexadecimal to sign.\n   * @param params.hdPath - The BIP 32 path of the account.\n   * @returns Retrieve v, r, s from the signed transaction.\n   */\n  async deviceSignTransaction({\n    tx,\n    hdPath,\n  }: LedgerSignTransactionParams): Promise<LedgerSignTransactionResponse> {\n    const resolution = await ledgerService.resolveTransaction(tx, {}, {});\n    return this.#getEthApp().signTransaction(hdPath, tx, resolution);\n  }\n\n  /**\n   * Method to retrieve the ethereum address for a given BIP 32 path.\n   *\n   * @param params - An object contains hdPath.\n   * @param params.hdPath - The BIP 32 path of the account.\n   * @returns An object contains publicKey, address and chainCode.\n   */\n  async getPublicKey({\n    hdPath,\n  }: GetPublicKeyParams): Promise<GetPublicKeyResponse> {\n    return await this.#getEthApp().getAddress(hdPath, false, true);\n  }\n\n  /**\n   * Method to retrieve the current configuration.\n   *\n   * @returns Retrieve current configuration.\n   */\n  async getOptions(): Promise<LedgerMobileBridgeOptions> {\n    return this.#opts;\n  }\n\n  /**\n   * Method to set the current configuration.\n   *\n   * @param opts - An configuration object.\n   */\n  async setOptions(opts: LedgerMobileBridgeOptions): Promise<void> {\n    this.#opts = opts;\n  }\n\n  /**\n   * Method to set the transport object to communicate with the device.\n   *\n   * @param transport - The communication interface with the Ledger hardware wallet. There are different kind of transports based on the technology (channels like U2F, HID, Bluetooth, Webusb).\n   * @returns Retrieve boolean.\n   */\n  async updateTransportMethod(transport: Transport): Promise<boolean> {\n    if (!transport.deviceModel) {\n      throw new Error('Property `deviceModel` is not defined in `transport`.');\n    }\n    if (!transport.deviceModel.id) {\n      throw new Error(\n        'Property `deviceModel.id` is not defined in `transport`.',\n      );\n    }\n    this.#getTransportMiddleWare().setTransport(transport);\n    this.isDeviceConnected = true;\n    return Promise.resolve(true);\n  }\n\n  /**\n   * Method to init eth app object on ledger device.\n   * This method is not supported on mobile.\n   */\n  async attemptMakeApp(): Promise<boolean> {\n    throw new Error('Method not supported.');\n  }\n\n  /**\n   * Method to open ethereum application on ledger device.\n   *\n   */\n  async openEthApp(): Promise<void> {\n    await this.#getEthApp().openEthApp();\n  }\n\n  /**\n   * Method to close all running application on ledger device.\n   *\n   */\n  async closeApps(): Promise<void> {\n    await this.#getEthApp().closeApps();\n  }\n\n  /**\n   * Method to retrieve the name and version of the running application in ledger device.\n   *\n   * @returns An object contains appName and version.\n   */\n  async getAppNameAndVersion(): Promise<GetAppNameAndVersionResponse> {\n    return this.#getEthApp().getAppNameAndVersion();\n  }\n\n  /**\n   * Method to retrieve the transport middleWare object.\n   *\n   * @returns The TransportMiddleware object.\n   */\n  #getTransportMiddleWare(): TransportMiddleware {\n    if (this.#transportMiddleware) {\n      return this.#transportMiddleware;\n    }\n    throw new Error('Instance `transportMiddleware` is not initialized.');\n  }\n\n  /**\n   * Method to retrieve the ledger Eth App object.\n   *\n   * @returns The ledger Eth App object.\n   */\n  #getEthApp(): MetaMaskLedgerHwAppEth {\n    return this.#getTransportMiddleWare().getEthApp();\n  }\n}\n"]}
\ No newline at end of file
+{"version":3,"file":"ledger-mobile-bridge.js","sourceRoot":"","sources":["../src/ledger-mobile-bridge.ts"],"names":[],"mappings":"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","sourcesContent":["import type Transport from '@ledgerhq/hw-transport';\n\nimport {\n  GetPublicKeyParams,\n  GetPublicKeyResponse,\n  LedgerBridge,\n  LedgerSignMessageParams,\n  LedgerSignMessageResponse,\n  LedgerSignTransactionParams,\n  LedgerSignTransactionResponse,\n  LedgerSignTypedDataParams,\n  LedgerSignTypedDataResponse,\n} from './ledger-bridge';\nimport { MetaMaskLedgerHwAppEth } from './ledger-hw-app';\nimport { TransportMiddleware } from './ledger-transport-middleware';\nimport {\n  GetAppNameAndVersionResponse,\n  LedgerMobileBridgeOptions,\n} from './type';\n\n// MobileBridge Type will always use LedgerBridge with LedgerMobileBridgeOptions\nexport type MobileBridge = LedgerBridge<LedgerMobileBridgeOptions> & {\n  getAppNameAndVersion(): Promise<GetAppNameAndVersionResponse>;\n  openEthApp(): Promise<void>;\n  closeApps(): Promise<void>;\n};\n\n/**\n * LedgerMobileBridge is a bridge between the LedgerKeyring and the LedgerTransportMiddleware.\n */\nexport class LedgerMobileBridge implements MobileBridge {\n  readonly #transportMiddleware?: TransportMiddleware;\n\n  #opts: LedgerMobileBridgeOptions;\n\n  isDeviceConnected = false;\n\n  constructor(\n    transportMiddleware: TransportMiddleware,\n    opts: LedgerMobileBridgeOptions = {},\n  ) {\n    this.#opts = opts;\n    this.#transportMiddleware = transportMiddleware;\n  }\n\n  /**\n   * Method to initializes the keyring.\n   * Mobile ledger doesnt not require init.\n   *\n   * @returns A promise that will resolve once the bridge is initialized.\n   */\n  async init(): Promise<void> {\n    return Promise.resolve();\n  }\n\n  /**\n   * Method to destroy the keyring.\n   * It will dispose the transportmiddleware and set isDeviceConnected to false.\n   */\n  async destroy(): Promise<void> {\n    try {\n      await this.#getTransportMiddleWare().dispose();\n    } catch (error) {\n      // eslint-disable-next-line no-console\n      console.error(error);\n    }\n    this.isDeviceConnected = false;\n  }\n\n  /**\n   * Method to sign a string Message.\n   * Sending the string message to the device and returning the signed message.\n   *\n   * @param params - An object contains hdPath and message.\n   * @param params.hdPath - The BIP 32 path of the account.\n   * @param params.message - The message to sign.\n   * @returns Retrieve v, r, s from the signed message.\n   */\n  async deviceSignMessage({\n    hdPath,\n    message,\n  }: LedgerSignMessageParams): Promise<LedgerSignMessageResponse> {\n    return this.#getEthApp().signPersonalMessage(hdPath, message);\n  }\n\n  /**\n   * Method to sign a EIP712 Message.\n   * Sending the typed data message to the device and returning the signed message.\n   *\n   * @param params - An object contains hdPath, domainSeparatorHex and hashStructMessageHex.\n   * @param params.hdPath - The BIP 32 path of the account.\n   * @param params.message - The EIP712 message to sign.\n   * @returns Retrieve v, r, s from the signed message.\n   */\n  async deviceSignTypedData({\n    hdPath,\n    message,\n  }: LedgerSignTypedDataParams): Promise<LedgerSignTypedDataResponse> {\n    return this.#getEthApp().signEIP712Message(hdPath, message);\n  }\n\n  /**\n   * Method to sign a transaction\n   * Sending the hexadecimal transaction message to the device and returning the signed transaction.\n   *\n   * @param params - An object contains tx, hdPath.\n   * @param params.tx - The raw ethereum transaction in hexadecimal to sign.\n   * @param params.hdPath - The BIP 32 path of the account.\n   * @returns Retrieve v, r, s from the signed transaction.\n   */\n  async deviceSignTransaction({\n    tx,\n    hdPath,\n  }: LedgerSignTransactionParams): Promise<LedgerSignTransactionResponse> {\n    const ethApp = this.#getEthApp();\n\n    return ethApp.clearSignTransaction(hdPath, tx, {\n      externalPlugins: true,\n      erc20: true,\n      nft: true,\n    });\n  }\n\n  /**\n   * Method to retrieve the ethereum address for a given BIP 32 path.\n   *\n   * @param params - An object contains hdPath.\n   * @param params.hdPath - The BIP 32 path of the account.\n   * @returns An object contains publicKey, address and chainCode.\n   */\n  async getPublicKey({\n    hdPath,\n  }: GetPublicKeyParams): Promise<GetPublicKeyResponse> {\n    return await this.#getEthApp().getAddress(hdPath, false, true);\n  }\n\n  /**\n   * Method to retrieve the current configuration.\n   *\n   * @returns Retrieve current configuration.\n   */\n  async getOptions(): Promise<LedgerMobileBridgeOptions> {\n    return this.#opts;\n  }\n\n  /**\n   * Method to set the current configuration.\n   *\n   * @param opts - An configuration object.\n   */\n  async setOptions(opts: LedgerMobileBridgeOptions): Promise<void> {\n    this.#opts = opts;\n  }\n\n  /**\n   * Method to set the transport object to communicate with the device.\n   *\n   * @param transport - The communication interface with the Ledger hardware wallet. There are different kind of transports based on the technology (channels like U2F, HID, Bluetooth, Webusb).\n   * @returns Retrieve boolean.\n   */\n  async updateTransportMethod(transport: Transport): Promise<boolean> {\n    if (!transport.deviceModel) {\n      throw new Error('Property `deviceModel` is not defined in `transport`.');\n    }\n    if (!transport.deviceModel.id) {\n      throw new Error(\n        'Property `deviceModel.id` is not defined in `transport`.',\n      );\n    }\n    this.#getTransportMiddleWare().setTransport(transport);\n    this.isDeviceConnected = true;\n    return Promise.resolve(true);\n  }\n\n  /**\n   * Method to init eth app object on ledger device.\n   * This method is not supported on mobile.\n   */\n  async attemptMakeApp(): Promise<boolean> {\n    throw new Error('Method not supported.');\n  }\n\n  /**\n   * Method to open ethereum application on ledger device.\n   *\n   */\n  async openEthApp(): Promise<void> {\n    await this.#getEthApp().openEthApp();\n  }\n\n  /**\n   * Method to close all running application on ledger device.\n   *\n   */\n  async closeApps(): Promise<void> {\n    await this.#getEthApp().closeApps();\n  }\n\n  /**\n   * Method to retrieve the name and version of the running application in ledger device.\n   *\n   * @returns An object contains appName and version.\n   */\n  async getAppNameAndVersion(): Promise<GetAppNameAndVersionResponse> {\n    return this.#getEthApp().getAppNameAndVersion();\n  }\n\n  /**\n   * Method to retrieve the transport middleWare object.\n   *\n   * @returns The TransportMiddleware object.\n   */\n  #getTransportMiddleWare(): TransportMiddleware {\n    if (this.#transportMiddleware) {\n      return this.#transportMiddleware;\n    }\n    throw new Error('Instance `transportMiddleware` is not initialized.');\n  }\n\n  /**\n   * Method to retrieve the ledger Eth App object.\n   *\n   * @returns The ledger Eth App object.\n   */\n  #getEthApp(): MetaMaskLedgerHwAppEth {\n    return this.#getTransportMiddleWare().getEthApp();\n  }\n}\n"]}
\ No newline at end of file
